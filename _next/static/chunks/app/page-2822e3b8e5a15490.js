(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2359:function(e,t,i){Promise.resolve().then(i.bind(i,8615))},8615:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return tN}});var n=i(7437),r=i(2265),s=i(7868);class a{async getAllAnnotations(){try{return await this.table.toArray()}catch(e){}}async getAnnotationsByBookId(e){try{return await this.table.where("bookId").equals(e).toArray()}catch(e){}}async getAnnotationById(e){try{return await this.table.get(e)}catch(e){}}async addAnnotation(e){try{return await this.table.add(e)}catch(e){}}async updateAnnotation(e,t){try{return await this.table.update(e,t)}catch(e){}}async deleteAnnotation(e){try{return await this.table.delete(e)}catch(e){}}constructor(e){this.table=e.table("annotationsTable")}}class o{async getLastReadRecord(e){try{return await this.table.get(e)}catch(e){}}setLastReadRecord(e,t){try{return this.table.put(e,t)}catch(e){}}constructor(e){this.table=e.table("lastReadTable")}}class l{async getSetting(e){try{var t;return null===(t=await this.table.get(e))||void 0===t?void 0:t.value}catch(e){}}async getAllSettings(){try{return(await this.table.toArray()).reduce((e,t)=>{let{key:i,value:n}=t;return{...e,[i]:n}},{})}catch(e){}}setSetting(e,t){try{return this.table.put({key:e,value:t})}catch(e){}}deleteSetting(e){try{return this.table.delete(e)}catch(e){}}constructor(e){this.table=e.table("settingsTable")}}class d extends s.ZP{constructor(){super("EvoReaderDB"),this.version(1).stores({lastReadTable:"filePath, bookId, updatedAt",settingsTable:"key",annotationsTable:"id, bookId"}),this.lastReadTable=new o(this),this.settingsTable=new l(this),this.annotationsTable=new a(this)}}let c=new d;var h=i(2063),u=i(6435);let p={settings:{fontsize:16,showSideBar:"",sidebarWidth:300,theme:"light",userContentStyle:"#evo-content {\n  font-size: 16px;\n  line-height: 1.6;\n  max-width: 34em;\n  padding-top: 1em;\n  padding-bottom: 2em;\n}"},isBookLoading:!1,showSideBar:"toc",ebookUrl:"",ebookPath:"",ebookFileName:"",ebookSize:0},f=r.createContext({readerProps:p,setReaderProps:()=>{}}),g=e=>{let{children:t}=e,[i,s]=(0,r.useState)(!1),[a,o]=(0,r.useState)(p);(0,r.useEffect)(()=>{c.settingsTable.getAllSettings().then(e=>{Object.keys(p.settings).forEach(t=>{e&&void 0!==e[t]||c.settingsTable.setSetting(t,p.settings[t])}),o(t=>({...t,settings:{...t.settings,...e}}))}).finally(()=>{s(!0)})},[]);let l=(0,h.Z)(a.settings);(0,r.useEffect)(()=>{if(!l||!i)return;let e=a.settings;Object.keys(e).forEach(t=>{l[t]!==e[t]&&c.settingsTable.setSetting(t,e[t])})},[a.settings,i]);let{setTheme:d}=(0,u.F)();(0,r.useEffect)(()=>{if(!i)return;let e=a.settings.theme;e&&d(e)},[i,a.settings.theme,d]),(0,r.useEffect)(()=>{async function e(e){let t=e[0],i=await t.getFile(),n=URL.createObjectURL(i),r=t.name;o(e=>({...e,ebookUrl:n,ebookPath:r,ebookFileName:r,ebookSize:i.size}))}window.electronApi&&window.electronApi.ipcRenderer.on("IPCWEB::FILE-OPENED",e=>{let{fileData:t,filePath:i,fileSize:n}=e,r=new Blob([t],{type:"application/epub+zip"}),s=URL.createObjectURL(r),a=e.filePath.split(/[/\\]/).pop()||"";o(e=>({...e,ebookUrl:s,ebookPath:i,ebookFileName:a,ebookSize:n}))}),"launchQueue"in window&&window.launchQueue.setConsumer(t=>{e(t.files)})},[]);let g=(0,r.useMemo)(()=>({readerProps:a,setReaderProps:o}),[a,o]);return(0,n.jsx)(f.Provider,{value:g,children:i&&t})};var m=i(5245),v=i.n(m),x=i(3571),b=i.n(x),y=i(4436);class w{async open(e){this.zipReader=new y.Mr(new y.Nt(e));let t=await this.zipReader.getEntries();this.entries=new Map(t.map(e=>[e.filename,e]))}async readEntry(e){var t;if(!this.entries)throw Error("Archive not opened");let i=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!i)throw Error("File not found in archive: ".concat(e));if(i.directory)throw Error("File is a directory: ".concat(e));if(!i.getData)throw Error("File cannot be read: ".concat(e));let n=new y.Ek;return await i.getData(n)}async createUrl(e){var t;if(!this.entries)throw Error("Archive not opened");let i=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!i)throw Error("File not found in archive: ".concat(e));if(i.directory)throw Error("File is a directory: ".concat(e));if(!i.getData)throw Error("File cannot be read: ".concat(e));let n=new y.U5,r=await i.getData(n);return URL.createObjectURL(r)}constructor(){this.zipReader=void 0,this.entries=void 0}}function N(e,t){let i;if(!e)throw Error("No Element Provided");return void 0!==e.querySelector?e.querySelector(t):(i=e.getElementsByTagName(t)).length?i[0]:null}function S(e,t){return void 0!==e.querySelector?e.querySelectorAll(t):e.getElementsByTagName(t)}function j(e,t,i){let n,r;if(void 0!==e.querySelector){for(let e in t+="[",i)t+=e+"~='"+i[e]+"'";return t+="]",e.querySelector(t)}if(n=e.getElementsByTagName(t),r=Array.prototype.slice.call(n,0).filter(function(e){for(let t in i)if(e.getAttribute(t)===i[t])return!0;return!1}))return r[0]}function E(e,t){let i=DOMParser;return 65279===e.charCodeAt(0)&&(e=e.slice(1)),new i().parseFromString(e,t)}function T(e,t){switch(v().extname(t)){case".xml":case".opf":case".ncx":default:return E(e,"text/xml");case".xhtml":return E(e,"application/xhtml+xml");case".html":case".htm":return E(e,"text/html")}}function C(e,t,i){let n=[],r=e.childNodes;for(let e=0;e<r.length;e++){let s=r[e];if(1===s.nodeType&&s.nodeName.toLowerCase()===t){if(i)return s;n.push(s)}}if(!i)return n}function k(e,t){let i;if(null!==e&&""!==t)for(i=e.parentNode;1===i.nodeType;){if(i.tagName.toLowerCase()===t)return i;i=i.parentNode}}function R(e){for(var t=[],i=e.childNodes,n=0;n<i.length;n++){let e=i[n];1===e.nodeType&&t.push(e)}return t}class A{parse(e){var t;if(!e)throw Error("Container File Not Found");let i=N(e,"rootfile");if(!i)throw Error("No RootFile Found");this.opfPath=null!==(t=i.getAttribute("full-path"))&&void 0!==t?t:""}constructor(){this.encoding="",this.opfPath=""}}class _{checkType(e){return"string"==typeof e&&_.isCfiString(e)?"string":e&&"object"==typeof e&&("Range"===Object.prototype.toString.call(e).slice(8,-1)||void 0!==e.startContainer)?"range":e&&"object"==typeof e&&void 0!==e.nodeType?"node":!!e&&"object"==typeof e&&e instanceof _&&"EpubCFI"}parse(e){let t,i,n;if("string"!=typeof e)return{spinePos:-1};let r=_.extractCfi(e);return(t=_.getChapterComponent(r))?(this.baseParts=this.parseComponent(t),i=_.getPathComponent(r)||"",this.path=this.parseComponent(i),(n=this.getRange(r))&&(this.isRange=!0,this.start=this.parseComponent(n[0]),this.end=this.parseComponent(n[1])),this.spineIndex=this.baseParts.steps[1].index,this):{spinePos:-1}}parseComponent(e){let t;let i={steps:[],terminal:{offset:null,assertion:null}},n=e.split(":"),r=n[0].split("/");return n.length>1&&(t=n[1],i.terminal=this.parseTerminal(t)),""===r[0]&&r.shift(),i.steps=r.map(e=>this.parseStep(e)),i}parseStep(e){let t,i,n,r,s;return((r=e.match(/\[(.*)\]/))&&r[1]&&(s=r[1]),isNaN(i=parseInt(e)))?{type:"element",index:1,id:s||""}:(i%2==0?(t="element",n=i/2-1):(t="text",n=(i-1)/2),{type:t,index:n,id:s||""})}parseTerminal(e){var t;let i,n=null,r=e.match(/\[(.*)\]/);return r&&r[1]?(i=parseInt(e.split("[")[0]),n=r[1]):i=parseInt(e),!isNaN(parseFloat(t=i))&&isFinite(t)||(i=null),{offset:i,assertion:n}}static extractCfi(e){let t="";return 0===e.indexOf("epubcfi(")&&")"===e[e.length-1]&&(t=e.slice(8,e.length-1)),t}static getChapterComponent(e){return e.split("!")[0]}static getPathComponent(e){let t=e.split("!");if(t[1])return t[1].split(",")[0]}getRange(e){let t=e.split(",");if(3===t.length)return[t[1],t[2]]}getCharecterOffsetComponent(e){return e.split(":")[1]||""}joinSteps(e){return e?e.map(function(e){var t="";return"element"===e.type&&(t+=(e.index+1)*2),"text"===e.type&&(t+=1+2*e.index),e.id&&(t+="["+e.id+"]"),t}).join("/"):""}segmentString(e){var t="/";return t+=this.joinSteps(e.steps),e.terminal&&null!=e.terminal.offset&&(t+=":"+e.terminal.offset),e.terminal&&null!=e.terminal.assertion&&(t+="["+e.terminal.assertion+"]"),t}toString(){var e="epubcfi(";return e+=this.segmentString(this.baseParts)+"!"+this.segmentString(this.path),this.isRange&&this.start&&(e+=","+this.segmentString(this.start)),this.isRange&&this.end&&(e+=","+this.segmentString(this.end)),e+=")"}static compare(e,t){let i,n;if(i="string"==typeof e?new _(e):e,n="string"==typeof t?new _(t):t,i.spineIndex>n.spineIndex)return 1;if(i.spineIndex<n.spineIndex)return -1;i.isRange?(r=i.path.steps.concat((null===(l=i.start)||void 0===l?void 0:l.steps)||[]),a=null===(d=i.start)||void 0===d?void 0:d.terminal):(r=i.path.steps,a=i.path.terminal),n.isRange?(s=n.path.steps.concat((null===(c=n.start)||void 0===c?void 0:c.steps)||[]),o=null===(h=n.start)||void 0===h?void 0:h.terminal):(s=n.path.steps,o=n.path.terminal);for(var r,s,a,o,l,d,c,h,u=0;u<r.length;u++){if(!r[u])return -1;if(!s[u]||r[u].index>s[u].index)return 1;if(r[u].index<s[u].index)return -1}if(r.length<s.length)return -1;if((null==a?void 0:a.offset)&&(null==o?void 0:o.offset)){if(a.offset>o.offset)return 1;if(a.offset<o.offset)return -1}return 0}step(e){var t;let i=3===e.nodeType?"text":"element";return{id:null!==(t=e.id)&&void 0!==t?t:"",tagName:e.tagName,type:i,index:this.position(e)}}filteredStep(e,t){var i,n=this.filter(e,t);if(n)return i=3===n.nodeType?"text":"element",{id:n.id,tagName:n.tagName,type:i,index:this.filteredPosition(n,t)}}pathTo(e,t,i){let n={steps:[],terminal:{offset:null,assertion:null}};for(var r,s=e;s&&s.parentNode&&"EVO-HTML"!==s.tagName;)(r=i?this.filteredStep(s,i):this.step(s))&&n.steps.unshift(r),s=s.parentNode;return null!==t&&t>=0&&(n.terminal.offset=t,n.steps.length>0&&"text"!==n.steps[n.steps.length-1].type&&n.steps.push({type:"text",index:0,id:""})),n}equalStep(e,t){return!!e&&!!t&&e.index===t.index&&e.id===t.id&&e.type===t.type}parseFromRange(e,t,i){let n=e.startContainer,r=e.endContainer,s=e.startOffset,a=e.endOffset,o=!1;if(i){var l;o=(null===(l=n.ownerDocument)||void 0===l?void 0:l.querySelector("."+i))!==null}if(t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),e.collapsed)o&&(s=this.patchOffset(n,s,i)),this.path=this.pathTo(n,s,i);else{this.isRange=!0,o&&(s=this.patchOffset(n,s,i)),this.start=this.pathTo(n,s,i),o&&(a=this.patchOffset(r,a,i)),this.end=this.pathTo(r,a,i),this.path={steps:[],terminal:{offset:null,assertion:null}};var d,c=this.start.steps.length;for(d=0;d<c;d++)if(this.equalStep(this.start.steps[d],this.end.steps[d]))d===c-1?this.start.terminal===this.end.terminal&&(this.path.steps.push(this.start.steps[d]),this.isRange=!1):this.path.steps.push(this.start.steps[d]);else break;this.start.steps=this.start.steps.slice(this.path.steps.length),this.end.steps=this.end.steps.slice(this.path.steps.length)}return this}parseFromNode(e,t,i){return t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),this.path=this.pathTo(e,null,i),this}filter(e,t){var i,n,r,s,a,o,l=!1;return(3===e.nodeType?(l=!0,r=e.parentNode,i=null===(o=e.parentNode)||void 0===o?void 0:o.classList.contains(t)):(l=!1,i=e.classList.contains(t)),i&&l)?(s=r.previousSibling,a=r.nextSibling,s&&3===s.nodeType?n=s:a&&3===a.nodeType&&(n=a),n)?n:e:(!i||!!l)&&e}patchOffset(e,t,i){if(3!=e.nodeType)throw Error("Anchor must be a text node");var n=e,r=t;for(e.parentNode.classList.contains(i)&&(n=e.parentNode);n.previousSibling;){if(1===n.previousSibling.nodeType){if(n.previousSibling.classList.contains(i))r+=n.previousSibling.textContent.length;else break}else r+=n.previousSibling.textContent.length;n=n.previousSibling}return r}normalizedMap(e,t,i){var n,r,s,a={},o=-1,l=e.length;for(s=0;s<l;s++)1===(n=e[s].nodeType)&&e[s].classList.contains(i)&&(n=3),s>0&&3===n&&3===r?a[s]=o:t===n&&(o+=1,a[s]=o),r=n;return a}position(e){var t,i;return 1===e.nodeType?((t=e.parentNode.children)||(t=R(e.parentNode)),i=Array.prototype.indexOf.call(t,e)):i=(t=this.textNodes(e.parentNode)).indexOf(e),i}filteredPosition(e,t){var i,n;return 1===e.nodeType?(i=e.parentNode.children,n=this.normalizedMap(i,1,t)):(i=e.parentNode.childNodes,e.parentNode.classList.contains(t)&&(i=(e=e.parentNode).parentNode.childNodes),n=this.normalizedMap(i,3,t)),n[Array.prototype.indexOf.call(i,e)]}stepsToXpath(e){var t=[".","*"];return e.forEach(e=>{var i=e.index+1;e.id?t.push("*[position()="+i+" and @id='"+e.id+"']"):"text"===e.type?t.push("text()["+i+"]"):t.push("*["+i+"]")}),t.join("/")}stepsToQuerySelector(e){var t=["html"];return e.forEach(function(e){var i=e.index+1;e.id?t.push("#"+e.id):"text"===e.type||t.push("*:nth-child("+i+")")}),t.join(">")}textNodes(e,t){return Array.prototype.slice.call(e.childNodes).filter(function(e){return 3===e.nodeType||!!(t&&e.classList.contains(t))})}walkToNode(e,t,i){var n,r,s=document;let a=t;var o=e.length;for(r=0;r<o&&("element"===(n=e[r]).type?a=n.id?s.getElementById(n.id)||a:R(a)[n.index]:"text"===n.type&&(a=this.textNodes(a,i)[n.index]),a);r++);return a}findNode(e,t,i){var n=t||document;return i?this.walkToNode(e,n,i):this.walkToNode(e,n)}fixMiss(e,t,i,n){var r,s,a=this.findNode(e.slice(0,-1),i,n),o=a.childNodes,l=this.normalizedMap(o,3,n),d=e[e.length-1].index;for(let e in l){if(!l.hasOwnProperty(e))return;if(l[e]===d){if(s=(r=o[e]).textContent.length,t>s)t-=s;else{a=1===r.nodeType?r.childNodes[0]:r;break}}}return{container:a,offset:t}}toRange(e){let t,i,n;let r=null,s=null,a=null,o=null;if(t=document.createRange(),this.isRange&&this.start&&this.end?(r=this.start,i=this.path.steps.concat(r.steps||[]),a=this.findNode(i,e),s=this.end,n=this.path.steps.concat(s.steps||[]),o=this.findNode(n,e)):(r=this.path,i=this.path.steps,a=this.findNode(this.path.steps,e)),!a)return null;try{null!==r.terminal.offset?t.setStart(a,r.terminal.offset):t.setStart(a,0)}catch(e){}if(o)try{(null==s?void 0:s.terminal.offset)!=null?t.setEnd(o,s.terminal.offset):t.setEnd(o,0)}catch(e){}return t}static isCfiString(e){return"string"==typeof e&&0===e.indexOf("epubcfi(")&&")"===e[e.length-1]}static generateChapterComponent(e,t,i){let n="/"+(e+1)*2+"/";return n+=(t+1)*2,i&&(n+="["+i+"]"),n}collapse(e){this.isRange&&(this.isRange=!1,e?(this.path.steps=this.path.steps.concat(this.start.steps),this.path.terminal=this.start.terminal):(this.path.steps=this.path.steps.concat(this.end.steps),this.path.terminal=this.end.terminal))}constructor(e,t,i){if(this.str="",this.baseParts={steps:[],terminal:{offset:null,assertion:null}},this.spineIndex=0,this.isRange=!1,this.path={steps:[],terminal:{offset:null,assertion:null}},this.start=null,this.end=null,!(this instanceof _))return new _(e,t,i);"string"==typeof t&&(this.baseParts=this.parseComponent(t));let n=this.checkType(e);if("string"===n)this.str=e,this.parse(e);else if("range"===n)this.parseFromRange(e,this.baseParts,i),this.str=this.toString();else if("node"===n)this.parseFromNode(e,this.baseParts,i),this.str=this.toString();else if(!e)return this;else throw TypeError("not a valid argument for EpubCFI")}}class I{parse(e,t){if(this.baseDir=v().dirname(t)+"/",!e)throw Error("Package File Not Found");let i=N(e,"metadata");if(!i)throw Error("No Metadata Found");let n=N(e,"manifest");if(!n)throw Error("No Manifest Found");let r=N(e,"spine");if(!r)throw Error("No Spine Found");this.parseManifest(n),this.parseMetadata(i),this.navPath=this.findNavPath(n),this.ncxPath=this.findNcxPath(n,r),this.coverPath=this.findCoverPath(e),this.spineNodeIndex=function(e,t){let i=e.parentNode,n=null==i?void 0:i.childNodes,r=-1;if(n){let t;for(let i=0;i<n.length&&(1===(t=n[i]).nodeType&&r++,t!==e);i++);}return r}(r,0),this.spine=this.parseSpine(r),this.uniqueIdentifier=I.findUniqueIdentifier(e)}parseManifest(e){let t=new Map,i=new Map;e.querySelectorAll("item").forEach(e=>{let n=e.getAttribute("id")||"",r=e.getAttribute("href")||"",s=e.getAttribute("media-type")||"",a=e.getAttribute("media-overlay")||"",o=e.getAttribute("properties")||"",l=v().join(this.baseDir,r),d={id:n,href:r,path:l,type:s,overlay:a,properties:o.length?o.split(" "):[]};n&&t.set(n,d),r&&i.set(r,d)}),this.manifest=t,this.manifestByHref=i}parseMetadata(e){this.metadata.title=I.getElementText(e,"title"),this.metadata.creator=I.getElementText(e,"creator"),this.metadata.description=I.getElementText(e,"description"),this.metadata.pubdate=I.getElementText(e,"date"),this.metadata.publisher=I.getElementText(e,"publisher"),this.metadata.identifier=I.getElementText(e,"identifier"),this.metadata.language=I.getElementText(e,"language"),this.metadata.rights=I.getElementText(e,"rights"),this.metadata.modified_date=I.getPropertyText(e,"dcterms:modified"),this.metadata.layout=I.getPropertyText(e,"rendition:layout"),this.metadata.orientation=I.getPropertyText(e,"rendition:orientation"),this.metadata.flow=I.getPropertyText(e,"rendition:flow"),this.metadata.viewport=I.getPropertyText(e,"rendition:viewport"),this.metadata.media_active_class=I.getPropertyText(e,"media:active-class"),this.metadata.spread=I.getPropertyText(e,"rendition:spread")}parseSpine(e){let t=[];return e.querySelectorAll("itemref").forEach((e,i)=>{var n,r,s,a,o,l,d;let c=null!==(s=e.getAttribute("properties"))&&void 0!==s?s:"",h=null!==(a=e.getAttribute("idref"))&&void 0!==a?a:"",u=null!==(o=null===(n=this.manifest.get(h))||void 0===n?void 0:n.href)&&void 0!==o?o:"",p=null!==(l=null===(r=this.manifest.get(h))||void 0===r?void 0:r.path)&&void 0!==l?l:"",f=_.generateChapterComponent(this.spineNodeIndex,i,h),g={id:null!==(d=e.getAttribute("id"))&&void 0!==d?d:"",idref:h,href:u,path:p,baseDir:this.baseDir,linear:e.getAttribute("linear")||"yes",properties:c.length?c.split(" "):[],index:i,cfiBase:f};t.push(g)}),t}static findUniqueIdentifier(e){let t=e.documentElement.getAttribute("unique-identifier");if(!t)return"";let i=e.getElementById(t);if(!i)return"";if("identifier"===i.localName&&"http://purl.org/dc/elements/1.1/"===i.namespaceURI){var n;return(null===(n=i.childNodes[0].nodeValue)||void 0===n?void 0:n.trim())||""}return""}findNavPath(e){var t;let i=j(e,"item",{properties:"nav"}),n="",r=null!==(t=null==i?void 0:i.getAttribute("href"))&&void 0!==t?t:"";return""!==r&&(n=v().join(this.baseDir,r)),n}findNcxPath(e,t){var i;let n,r=j(e,"item",{"media-type":"application/x-dtbncx+xml"});!r&&(n=t.getAttribute("toc"))&&(r=e.querySelector("#".concat(n)));let s="",a=null!==(i=null==r?void 0:r.getAttribute("href"))&&void 0!==i?i:"";return""!==a&&(s=v().join(this.baseDir,a)),s}findCoverPath(e){var t,i;let n="",r=j(e,"item",{properties:"cover-image"});if(r){let e=null!==(t=r.getAttribute("href"))&&void 0!==t?t:"";if(""!==e)return v().join(this.baseDir,e)}let s=j(e,"meta",{name:"cover"});if(s){let t=s.getAttribute("content"),r=e.getElementById(t),a=null!==(i=null==r?void 0:r.getAttribute("href"))&&void 0!==i?i:"";""!==a&&(n=v().join(this.baseDir,a))}return n}static getElementText(e,t){let i=e.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",t);if(!i||0===i.length)return"";let n=i[0];if(n.childNodes.length){let{nodeValue:e}=n.childNodes[0];if(e)return e}return""}static getPropertyText(e,t){let i=j(e,"meta",{property:t});return i&&i.childNodes.length?i.childNodes[0].nodeValue:""}constructor(){this.baseDir="",this.manifest=new Map,this.manifestByHref=new Map,this.metadata={title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},this.navPath="",this.ncxPath="",this.coverPath="",this.spineNodeIndex=0,this.spine=[],this.uniqueIdentifier=""}}class P{parse(e,t,i){this.baseDir=v().dirname(i)+"/",e.nodeType&&(t?this.toc=this.parseNav(e):this.toc=this.parseNcx(e)),this.length=0,this.unpack(this.toc)}unpack(e){let t;for(let i=0;i<e.length;i++)t=e[i],this.tocFlat.push(t),t.href&&(this.tocByHref[t.href]=i),t.id&&(this.tocById[t.id]=i),this.length+=1,t.children.length>0&&this.unpack(t.children)}get(e){let t;return e?(0===e.indexOf("#")?t=this.tocById[e.substring(1)]:e in this.tocByHref&&(t=this.tocByHref[e]),this.getByIndex(e,t,this.toc)):this.toc}parseNav(e){let t;let i=function(e,t,i){let n;if(void 0!==e.querySelector&&(n=e.querySelector("".concat(t,'[*|type="').concat(i,'"]'))),n&&0!==n.length)return n;n=S(e,t);for(let e=0;e<n.length;e++)if(n[e].getAttributeNS("http://www.idpf.org/2007/ops","type")===i||n[e].getAttribute("epub:type")===i)return n[e]}(e,"nav","toc"),n=i?S(i,"li"):[],r=n.length,s=new Map,a=[];if(!n||0===r)return a;for(let e=0;e<r;e++){let i=this.navItem(n[e]);i&&(s.set(i.id,i),i.parent?(t=s.get(i.parent))&&t.children.push(i):a.push(i))}return a}navItem(e){let t=e.getAttribute("id")||void 0,i=C(e,"a",!0);if(!i)return;let n=i.getAttribute("href")||"";t||(t=n);let r=i.textContent||"",s=k(e,"li"),a="";if(s&&!(a=s.getAttribute("id")||"")){let e=C(s,"a",!0);a=e&&e.getAttribute("href")||""}for(;!a&&s;)if((s=k(s,"li"))&&!(a=s.getAttribute("id")||"")){let e=C(s,"a",!0);a=e&&e.getAttribute("href")||""}return{id:t,path:v().join(this.baseDir,n),href:n,label:r,children:[],parent:a}}parseNcx(e){let t;let i=S(e,"navPoint"),n=i.length,r=new Map,s=[];if(!i||0===n)return s;for(let e=0;e<n;++e)t=this.ncxItem(i[e]),r.set(t.id,t),t.parent?r.get(t.parent).children.push(t):s.push(t);return s}ncxItem(e){var t,i,n,r;let s=e.getAttribute("id")||"",a=N(e,"content"),o=null!==(i=null==a?void 0:a.getAttribute("src"))&&void 0!==i?i:"",l=N(e,"navLabel"),d=null!==(n=null==l?void 0:null===(t=l.textContent)||void 0===t?void 0:t.trim())&&void 0!==n?n:"",c=e.parentNode,h="";return c&&("navPoint"===c.nodeName||"navPoint"===c.nodeName.split(":").slice(-1)[0])&&(h=null!==(r=c.getAttribute("id"))&&void 0!==r?r:""),{id:s,path:v().join(this.baseDir,o),href:o,label:d,children:[],parent:h}}load(e){return e.map(e=>(e.label=e.title,e.children=e.children?this.load(e.children):[],e))}forEach(e){return this.toc.forEach(e)}constructor(){this.baseDir="/",this.toc=[],this.tocFlat=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},this.length=0}}class L{constructor(e,t,i){this.idref=e.idref,this.linear="yes"===e.linear,this.properties=e.properties,this.index=e.index,this.href=e.href,this.path=e.path,this.cfiBase=e.cfiBase,this.nextIndex=t,this.prevIndex=i}}class B{parse(e){this.opfSpine=e,this.length=e.length,e.forEach((t,i)=>{let n=-1,r=-1;if("yes"===t.linear){for(let t=i+1;t<e.length;t++)if("yes"===e[t].linear){n=t;break}for(let t=i-1;t>=0;t--)if("yes"===e[t].linear){r=t;break}}let s=new L(t,n,r);this.sectionItems.push(s),this.sectionItemsByPath[s.path]=s,this.sectionItemsByIdref[s.idref]=s,this.sectionItemsByCfibase[s.cfiBase]=s})}getSection(e){let t=0;if(void 0===e)for(;t<this.sectionItems.length;){let e=this.sectionItems[t];if(e&&e.linear)break;t+=1}else if("string"==typeof e&&_.isCfiString(e)){let t=_.extractCfi(e),i=_.getChapterComponent(t);return this.sectionItemsByCfibase[i]||null}else if("number"==typeof e)t=e;else if("string"==typeof e){var i;let n=e.split("#")[0];t=(null===(i=this.sectionItemsByPath[n])||void 0===i?void 0:i.index)||-1}return this.sectionItems[t]||null}constructor(){this.sectionItems=[],this.sectionItemsByPath={},this.sectionItemsByIdref={},this.sectionItemsByCfibase={},this.opfSpine=void 0,this.length=0}}class F{async parse(e,t){this.manifest=e,this.resources=Array.from(e.values()),this.html=this.resources.filter(e=>"application/xhtml+xml"===e.type||"text/html"===e.type),await Promise.all(Array.from(this.manifest.values()).map(async e=>{if("application/xhtml+xml"!==e.type&&"text/html"!==e.type){let i=await t.createUrl(e.path);this.assets.set(e.path,{...e,url:i})}if("text/css"===e.type){let i=await t.readEntry(e.path);this.css.set(e.path,{...e,text:i})}}))}constructor(){this.manifest=void 0,this.resources=[],this.html=[],this.assets=new Map,this.css=new Map,this.assetsUrls=[],this.cssUrls=[]}}let M="META-INF/container.xml";class D{async parse(e){try{await this.archive.open(e),await this.openContainer(),await this.openOpf(),this.resource.parse(this.opf.manifest,this.archive),await this.loadNavigation(),this.spine.parse(this.opf.spine)}catch(e){return Promise.reject(e)}return this}async openContainer(){let e=T(await this.archive.readEntry(M),M);this.container.parse(e)}async openOpf(){let e=this.container.opfPath,t=T(await this.archive.readEntry(e),e);this.opf.parse(t,e)}async loadNavigation(){let e=!0,t=this.opf.navPath;""===t&&(e=!1,t=this.opf.ncxPath);let i=T(await this.archive.readEntry(t),t);this.navigation.parse(i,e,t)}getSection(e){let t=this.spine.getSection(e);return t?(this.currentSectionIndex=t.index,t):null}async loadSection(e){let t=await this.archive.readEntry(e.path);return await this.parseHtmlContent(t,e.path)}async parseHtmlContent(e,t){let i=new DOMParser().parseFromString(e,"application/xhtml+xml");i.querySelectorAll("img").forEach(e=>{let i=e.getAttribute("src");if(!i)return;let n=v().join(t,"..",i),r=this.resource.assets.get(n),s=(null==r?void 0:r.url)||"";e.setAttribute("src",s)}),i.querySelectorAll("image").forEach(e=>{let i=e.getAttribute("xlink:href");if(!i)return;let n=v().join(t,"..",i),r=this.resource.assets.get(n),s=(null==r?void 0:r.url)||"";e.setAttribute("xlink:href",s)});let n=e=>{let i=e.getAttribute("href");if(!i||0===i.indexOf("mailto:")||0===i.indexOf("#"))return;if(i.indexOf("://")>-1){e.setAttribute("target","");return}let n=i.split("#")[1]||"",r=i.split("#")[0],s=v().join(t,"..",r),a=n?"".concat(s,"#").concat(n):s;e.setAttribute("href",a)};i.querySelectorAll("a[href]").forEach(e=>{n(e)});let r=[];i.querySelectorAll("link").forEach(e=>{let i=e.getAttribute("href");if(!i)return;let n=v().join(t,"..",i),s=this.resource.css.get(n);if(!s)return;let a=s.text.replace(/body/g,"evo-body"),o=a.match(/url\((.*?)\)/g);if(o)for(let e of o){let t=null==e?void 0:e.match(/url\((.*?)\)/);if(!t)continue;let i=t[1],r=v().join(n,"..",i),s=this.resource.assets.get(r),o=(null==s?void 0:s.url)||"";a=a.replace(i,o)}r.push(a)});let s=i.querySelector("body"),a="";if(s){let e=i.createElement("evo-body");e.innerHTML=s.innerHTML,a="<evo-head></evo-head>".concat(e.outerHTML)}return{htmlContent:b().sanitize(a,{ALLOW_UNKNOWN_PROTOCOLS:!0,ADD_TAGS:["evo-html","evo-head","evo-body"]}),cssList:r}}async openPath(e){return await this.archive.readEntry(e)}async openHref(e){let t=this.opf.manifestByHref.get(e);if(!t)throw Error("Invalid epub href");let i=t.path;return await this.archive.readEntry(i)}constructor(){this.archive=new w,this.container=new A,this.opf=new I,this.navigation=new P,this.resource=new F,this.spine=new B,this.currentSectionIndex=0}}var O=i(1969),z=i(4640);let U={id:"",metadata:{title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},currentSection:null,currentSectionIndex:0,firstSectionLoading:!0,moveToTarget:"",currentCfi:"",currentTocItem:null},Z=r.createContext({bookProps:U,setBookProps:()=>{},epubRef:{current:null}}),H=e=>{let{children:t}=e,i=r.useRef(null),[s,a]=(0,r.useState)(U),{readerProps:o,setReaderProps:l}=(0,r.useContext)(f),[d,h]=O.ZP.useNotification(),u=(0,r.useMemo)(()=>({bookProps:s,setBookProps:a,epubRef:i}),[s,a,i]),p=async e=>{let t=await c.lastReadTable.getLastReadRecord(e);if(t)return t;c.lastReadTable.setLastReadRecord({bookId:s.id,filePath:o.ebookPath,cfi:"",percent:0,createdAt:Date.now(),updatedAt:Date.now()},o.ebookPath)};return(0,r.useEffect)(()=>{o.ebookUrl&&(l(e=>({...e,isBookLoading:!0})),a(U),(async()=>{let e=new D,t=await fetch(o.ebookUrl).then(e=>e.blob());await e.parse(t).catch(e=>{throw d.error({message:"打开失败：".concat(o.ebookUrl),description:"".concat(e.stack)}),l(e=>({...e,isBookLoading:!1})),Error(e)}),i.current=e;let n=e.opf.metadata,r=o.ebookFileName+o.ebookSize+n.title+n.pubdate+n.identifier,s=(0,z.Z)(r,z.Z.URL),c=await p(o.ebookPath),h=(null==c?void 0:c.cfi)||"",u=0;if(h){let t=e.getSection(h);u=(null==t?void 0:t.index)||0}return a(e=>({...e,id:s,metadata:n,currentSectionIndex:u,moveToTarget:h})),l(e=>({...e,isBookLoading:!1}))})(),document.title=o.ebookFileName?o.ebookFileName+" - EvoReader":"EvoReader")},[d,o.ebookPath,o.ebookUrl,l]),(0,n.jsxs)(Z.Provider,{value:u,children:[h,t]})},q=r.createContext({isAnnotationListLoading:!0,setIsAnnotationListLoading:()=>{},annotationList:[],setAnnotationList:()=>{}}),W=e=>{let{children:t}=e,{bookProps:i}=(0,r.useContext)(Z),[s,a]=r.useState([]),[o,l]=r.useState(!0);(0,r.useEffect)(()=>{i.id&&(l(!0),(async()=>{let e=await c.annotationsTable.getAnnotationsByBookId(i.id);e&&e.length>0?a(e):a([]),l(!1)})())},[i.id]);let d=r.useMemo(()=>({isAnnotationListLoading:o,setIsAnnotationListLoading:l,annotationList:s,setAnnotationList:a}),[s,o]);return(0,n.jsx)(q.Provider,{value:d,children:t})};var V=i(4007),Y=i(2186),X=i(9718),Q=i(6320),$=i.n(Q),G=e=>{let{mRef:t}=e,{readerProps:i,setReaderProps:s}=(0,r.useContext)(f),a=async e=>{if(e.target.files){i.ebookUrl&&URL.revokeObjectURL(i.ebookUrl);let t=e.target.files[0];if(!t)return;let n=URL.createObjectURL(t);s(e=>({...e,ebookUrl:n,ebookPath:t.name,ebookFileName:t.name,ebookSize:t.size}))}},o=async()=>{window.electronApi&&window.electronApi.ipcRenderer.sendMessage("IPCMAIN::ASK-OPEN-FILE")};return(0,n.jsx)(n.Fragment,{children:window.electronApi&&(0,n.jsx)("button",{ref:t,onClick:o,style:{display:"none"}})||(0,n.jsx)("input",{type:"file",accept:".epub",ref:t,onChange:a,style:{display:"none"}})})},J=i(2175),K=i(4056),ee=i(9121),et=i(2549),ei=i(230),en=i(7042),er=i(6768),es=i(4769);function ea(){let e=(0,ei._)(["",""]);return ea=function(){return e},e}function eo(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return(0,es.m6)((0,en.W)(t))}let el=er.ZP.div(ea(),e=>e.$cssText),ed=ee.fC,ec=ee.xz,eh=ee.h_;ee.x8;let eu=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(ee.aV,{ref:t,className:eo("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...r})});eu.displayName=ee.aV.displayName;let ep=r.forwardRef((e,t)=>{let{className:i,children:r,...s}=e;return(0,n.jsxs)(eh,{children:[(0,n.jsx)(eu,{}),(0,n.jsxs)(ee.VY,{ref:t,className:eo("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...s,children:[r,(0,n.jsxs)(ee.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,n.jsx)(et.Z,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});ep.displayName=ee.VY.displayName;let ef=e=>{let{className:t,...i}=e;return(0,n.jsx)("div",{className:eo("flex flex-col space-y-1.5 text-center sm:text-left",t),...i})};ef.displayName="DialogHeader";let eg=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(ee.Dx,{ref:t,className:eo("text-lg font-semibold leading-none tracking-tight",i),...r})});eg.displayName=ee.Dx.displayName,r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(ee.dk,{ref:t,className:eo("text-sm text-muted-foreground",i),...r})}).displayName=ee.dk.displayName;var em=i(6743);let ev=(0,i(9213).j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ex=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(em.f,{ref:t,className:eo(ev(),i),...r})});ex.displayName=em.f.displayName;var eb=i(6823);let ey=r.forwardRef((e,t)=>{let{className:i,orientation:r="horizontal",decorative:s=!0,...a}=e;return(0,n.jsx)(eb.f,{ref:t,decorative:s,orientation:r,className:eo("shrink-0 bg-border","horizontal"===r?"h-[1px] w-full":"h-full w-[1px]",i),...a})});ey.displayName=eb.f.displayName;var ew=i(3088),eN=i(4135),eS=e=>{let{}=e,{readerProps:t,setReaderProps:i}=(0,r.useContext)(f),s=t.settings.theme;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:$().icon,onClick:e=>{e.preventDefault(),i(e=>({...e,settings:{...e.settings,theme:"dark"===e.settings.theme?"light":"dark"}}))},children:"dark"===s?(0,n.jsx)(ew.Z,{size:"1em"}):(0,n.jsx)(eN.Z,{size:"1em"})})})},ej=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(f),i=(0,r.useRef)(null);return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:$().ActivityBar,children:[(0,n.jsxs)("div",{className:$().icon,onClick:()=>{var e;return null===(e=i.current)||void 0===e?void 0:e.click()},children:[(0,n.jsx)(V.Z,{}),(0,n.jsx)(G,{mRef:i})]}),(0,n.jsx)("div",{className:$().icon+("toc"===e.showSideBar?" "+$().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"toc"===e.showSideBar?"":"toc"}))},children:(0,n.jsx)(Y.Z,{})}),(0,n.jsx)("div",{className:$().icon+("style"===e.showSideBar?" "+$().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"style"===e.showSideBar?"":"style"}))},children:(0,n.jsx)(X.Z,{})}),(0,n.jsx)("div",{className:$().icon+("annotation"===e.showSideBar?" "+$().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"annotation"===e.showSideBar?"":"annotation"}))},children:(0,n.jsx)(J.Z,{size:"1em"})}),(0,n.jsx)(ey,{className:"mx-auto my-2 mt-auto w-4/5 bg-[#aaaaaa]"}),(0,n.jsx)(eS,{}),(0,n.jsxs)(ed,{children:[(0,n.jsx)(ec,{asChild:!0,children:(0,n.jsx)("div",{className:$().icon,children:(0,n.jsx)(K.Z,{size:"1em"})})}),(0,n.jsxs)(ep,{className:"sm:max-w-[500px]",children:[(0,n.jsx)(ef,{children:(0,n.jsx)(eg,{children:"About EvoReader"})}),(0,n.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,n.jsx)(ex,{className:"text-right",children:"Version:"}),(0,n.jsx)("span",{className:"col-span-3",children:"v1.0.0-beta"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,n.jsx)(ex,{htmlFor:"username",className:"text-right",children:"Feedback:"}),(0,n.jsx)("span",{className:"col-span-3",children:(0,n.jsx)("a",{href:"https://github.com/EvoReader/EvoReader/issues",className:"text-blue-500",target:"_blank",children:"https://github.com/EvoReader/EvoReader"})})]})]})]})]})]})})},eE=i(2705),eT=i(5561),eC=i(8170),ek=i(2398),eR=i(2017),eA=i(1210),e_=i(4899),eI=i.n(e_),eP=i(7303),eL=i.n(eP),eB=e=>{let{title:t="",children:i}=e;return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:eL().header,children:[(0,n.jsx)("div",{className:eL().title,children:t}),(0,n.jsx)("div",{className:eL().action,children:i})]})})};function eF(e){let{node:t,onClick:i}=e;return t.children&&0===t.children.length?(0,n.jsx)("span",{className:eI().arrow}):(0,n.jsx)("span",{className:eI().arrow,role:"presentation",onClick:i,children:t.isOpen?(0,n.jsx)(eC.Z,{}):(0,n.jsx)(ek.Z,{})})}function eM(e){let{node:t}=e,{bookProps:i,setBookProps:s,epubRef:a}=(0,r.useContext)(Z),o=e=>{var t;null===(t=i.handleMoveToTarget)||void 0===t||t.call(i,e)};return(0,n.jsxs)("div",{role:"presentation",style:{marginLeft:15*t.level+"px"},className:eI().node,onClick:()=>{t.data.path&&o(t.data.path),t.isOpen||t.open()},children:[(0,n.jsx)(eF,{node:t,onClick:e=>{e.stopPropagation(),t.toggle()}}),(0,n.jsx)("span",{className:eI().label,title:t.data.label,children:t.data.label})]})}var eD=()=>{var e;let{bookProps:t,setBookProps:i,epubRef:s}=(0,r.useContext)(Z),[a,o]=(0,r.useState)(null),[l,d]=(0,r.useState)([]),[c,h]=(0,r.useState)(new Map),{ref:u,width:p,height:f}=(0,eT.Z)(),g=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!s.current)return;let e=s.current;o(e.navigation.toc),d(e.navigation.tocFlat)},[s]),(0,r.useEffect)(()=>{if(t.firstSectionLoading)return;let e=l.filter(e=>{var i;return e.path.split("#")[0]===(null===(i=t.currentSection)||void 0===i?void 0:i.path)});if(0!==e.length&&(1===e.length&&i(t=>({...t,currentTocItem:e[0]})),e.length>1)){let i=new Map;e.forEach(e=>{var n;let r=e.href.split("#")[1],s=document.getElementById(r);if(!s)return;let a=new _(s,(null===(n=t.currentSection)||void 0===n?void 0:n.cfiBase)||"");i.set(e.id,a)}),h(i)}},[t.currentSection,l,t.firstSectionLoading]),(0,r.useEffect)(()=>{if(""===t.currentCfi||0===c.size)return;let e="",n=new _(t.currentCfi);for(let[t,i]of c){let r=_.compare(i,n);if(-1===r)e=t;else if(0===r){e=t;break}else if(1===r)break}let r=l.find(t=>t.id===e);r&&i(e=>({...e,currentTocItem:r}))},[t.currentCfi,c]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(eB,{title:"Table of Contents",children:[(0,n.jsx)(eR.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.openAll()},style:{marginRight:"6px"}}),(0,n.jsx)(eA.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.closeAll()}})]}),a&&(0,n.jsx)("div",{ref:u,className:eI().container,children:(0,n.jsx)(eE.m,{ref:g,selection:null===(e=t.currentTocItem)||void 0===e?void 0:e.id,disableMultiSelection:!0,data:a,indent:20,height:f,width:"100%",onMove:()=>{},renderCursor:()=>null,children:eM})})]})},eO=i(7606),ez=i(2198),eU=i.n(ez),eZ=i(8874);let{TextArea:eH}=eO.default;var eq=e=>{let{}=e,{readerProps:t,setReaderProps:i}=(0,r.useContext)(f),[s,a]=(0,r.useState)(t.settings.userContentStyle),{run:o}=(0,eZ.Z)(e=>{i(t=>({...t,settings:{...t.settings,userContentStyle:e}}))},{wait:100});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eB,{title:"User Style"}),(0,n.jsx)("div",{className:eU().container,children:(0,n.jsx)(eH,{value:s,onChange:e=>{let t=e.target.value;a(t),o(t)},style:{height:"90vh"}})})]})},eW=i(2067),eV=i.n(eW),eY=e=>{let{annotationData:t,onClickAnnotation:i}=e,r=(null==t?void 0:t.createdAt)?eV()(t.createdAt).format("MMM DD, YYYY, HH:MM"):"null",s=(null==t?void 0:t.text)||"null",a=(null==t?void 0:t.tocLabel)||"null";return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:"m-2 rounded-lg border transition-all hover:bg-accent cursor-pointer",onClick:()=>{(null==t?void 0:t.cfi)&&i(t.cfi)},children:[(0,n.jsx)("div",{className:"border-b flex justify-between items-center",children:(0,n.jsx)("div",{className:"pl-2",children:r})}),(0,n.jsx)("div",{className:"pt-2 pb-1 px-2",children:s}),(0,n.jsx)("div",{className:"ml-6 pb-2 pr-2 text-xs font-bold text-right text-ellipsis whitespace-nowrap overflow-hidden",children:a})]})})},eX=e=>{let{}=e,{isAnnotationListLoading:t,annotationList:i,setAnnotationList:s}=(0,r.useContext)(q),{bookProps:a}=(0,r.useContext)(Z),o=e=>{var t;null===(t=a.handleMoveToTarget)||void 0===t||t.call(a,e)};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eB,{title:"Annotation"}),(0,n.jsx)("div",{className:"h-full overflow-auto select-none",children:i.map(e=>(0,n.jsx)(eY,{annotationData:e,onClickAnnotation:o},e.id))})]})},eQ=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(f),[i,s]=r.useState(e.settings.sidebarWidth||300),{run:a}=(0,eZ.Z)(e=>{t(t=>({...t,settings:{...t.settings,sidebarWidth:e}}))},{wait:100}),o=e=>{s(e),a(e)};return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:eL().sidebar+" bg-neutral-50 dark:bg-neutral-900",style:{width:"".concat(i,"px"),minWidth:"200px",maxWidth:"".concat(.45*window.innerWidth,"px")},children:["toc"===e.showSideBar&&!e.isBookLoading&&""!==e.ebookUrl&&(0,n.jsx)(eD,{}),"style"===e.showSideBar&&(0,n.jsx)(eq,{}),"annotation"===e.showSideBar&&(0,n.jsx)(eX,{}),(0,n.jsx)("div",{onMouseDown:e=>{let n=e.clientX,r=e=>{let r=i+e.clientX-n;if(r<200){o(200),r<75&&t(e=>({...e,showSideBar:""}));return}if(r>.45*window.innerWidth){o(.45*window.innerWidth);return}o(r)},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),e.preventDefault()},className:eL().resizer,style:{left:"".concat(i-2,"px")}})]})})},e$=i(6715),eG=i(1773),eJ=i(9722),eK=i.n(eJ),e0=i(251),e1=()=>{var e,t;let{t:i}=(0,e0.$G)(),{bookProps:s,setBookProps:a,epubRef:o}=(0,r.useContext)(Z),l=null===(e=s.currentSection)||void 0===e?void 0:e.prevIndex,d=null===(t=s.currentSection)||void 0===t?void 0:t.nextIndex;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ey,{}),(0,n.jsxs)("div",{className:eK().footer+" bg-neutral-100 dark:bg-neutral-900",children:[(0,n.jsxs)("button",{onClick:()=>{if(s.handleMoveToTarget&&void 0!==l){var e;let t=null===(e=o.current)||void 0===e?void 0:e.getSection(l);t&&s.handleMoveToTarget(t,!1)}},disabled:void 0===l||l<0,children:[(0,n.jsx)(e$.Z,{className:"mr-1"}),i("viewer.prev")]}),(0,n.jsx)(ey,{orientation:"vertical"}),(0,n.jsxs)("button",{onClick:()=>{if(s.handleMoveToTarget&&void 0!==d){var e;let t=null===(e=o.current)||void 0===e?void 0:e.getSection(d);t&&s.handleMoveToTarget(t)}},disabled:void 0===d||d<0,children:[i("viewer.next"),(0,n.jsx)(eG.Z,{className:"ml-1"})]})]})]})},e2=i(4324),e3=i.n(e2),e5=i(6548),e4=i.n(e5),e6=e=>{let{}=e,t=(0,r.useRef)(null);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:e4().box,onClick:()=>{var e;return null===(e=t.current)||void 0===e?void 0:e.click()},children:[(0,n.jsx)(V.Z,{style:{fontSize:"40px"}}),(0,n.jsxs)("div",{className:e4().label,children:["拖拽文件进窗口 或 ",(0,n.jsx)("span",{style:{color:"#1b88ee"},children:"选择文件"})]}),(0,n.jsx)("div",{children:"支持 epub 格式"})]}),(0,n.jsx)(G,{mRef:t})]})},e8=i(8463),e7=i.n(e8),e9=e=>{let{mRef:t,section:i}=e,{bookProps:s,setBookProps:a,epubRef:o}=(0,r.useContext)(Z),[l,d]=(0,r.useState)(""),[c,h]=(0,r.useState)(""),u=async()=>{try{let e=o.current;if(!e)return;let t=await e.loadSection(i);d(t.htmlContent),h(t.cssList.join("\n"))}catch(e){}};(0,r.useEffect)(()=>{if(o.current){if(s.currentSectionIndex===i.index&&s.firstSectionLoading){u().then(()=>{a(e=>({...e,firstSectionLoading:!1}))});return}s.firstSectionLoading||s.currentSectionIndex===i.index||u()}},[s.firstSectionLoading]);let p=(0,r.useMemo)(()=>(0,n.jsx)(el,{$cssText:c,children:(0,n.jsx)("evo-html",{dangerouslySetInnerHTML:{__html:l},ref:t})}),[l,c]);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:e7().content,style:{display:s.currentSectionIndex===i.index?"block":"none"},children:(0,n.jsx)("div",{className:"evo-content",children:p})})})},te=i(4887),tt=i(92),ti=i.n(tt),tn=i(7137);class tr{page(e,t,i,n){if(e)return this.findStart(e,i,n)}walk(e,t){let i;let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE&&("img"===e.tagName.toLowerCase()||"image"===e.tagName.toLowerCase())?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),r=n.nextNode();for(;r&&!(i=t(r));)r=n.nextNode();return i}findStart(e,t,i){let n,r;let s=[e],a=e=>{let n=function(e){let t;let i=e.ownerDocument;if(e.nodeType==Node.TEXT_NODE){let n=i.createRange();n.selectNodeContents(e),t=n.getBoundingClientRect()}else t=e.getBoundingClientRect();return t}(e),r=n.top,a=n.bottom;if(r>t&&r<i||a-20>t)return e;s.push(e)};for(;s.length;)if((n=s.shift())&&(r=this.walk(n,a))){if(r.nodeType===Node.TEXT_NODE)return this.findTextStartRange(r,t,i)||r;return r}}findTextStartRange(e,t,i){let n;let r=this.splitTextNodeIntoRanges(e);for(let e=0;e<r.length;e++)if((n=r[e]).getBoundingClientRect().top>t)return n.collapse(!0),n}splitTextNodeIntoRanges(e){let t;let i=[],n=(e.textContent||"").trim(),r=e.ownerDocument;for(let s=0;s<n.length;s++)(t=r.createRange()).setStart(e,s),t.setEnd(e,s+1),i.push(t),t=!1;return i}rangePairToCfiPair(e,t){let i=t.start,n=t.end;return i.collapse(!0),n.collapse(!1),{start:i,end:n}}rangeListToCfiList(e,t){let i=[];for(let n=0;n<t.length;n++)i.push(this.rangePairToCfiPair(e,t[n]));return i}axis(e){return e&&(this.isHorizontal="horizontal"===e),this.isHorizontal}constructor(e,t,i){this.isHorizontal=!1,this.direction="ltr",this.isDev=!1,this.isHorizontal="horizontal"===t,this.direction=e||"ltr",this.isDev=i||!1}}var ts=i(3636),ta=i(5150),to=function(e){let[t,i]=(0,r.useState)(null),n=(0,r.useRef)(t),s=(0,r.useRef)(!1);return n.current=t,(0,ts.Z)(()=>{let t=(0,ta.getTargetElement)(e,document);if(!t)return;let r=()=>{let e=null;window.getSelection&&((e=window.getSelection())?e.toString():"")&&s.current&&i(e)},a=e=>{if(2===e.button||!window.getSelection)return;n.current&&i(null),s.current=!1;let r=window.getSelection();r&&(r.removeAllRanges(),s.current=t.contains(e.target))};return t.addEventListener("mouseup",r),document.addEventListener("mousedown",a),()=>{t.removeEventListener("mouseup",r),document.removeEventListener("mousedown",a)}},[],e),t},tl=i(7998),td=i(4021),tc=i(1552),th=i(846),tu=i(7322),tp=i(5618),tf=e=>{let{position:t,onClick:i}=e;if(!t)return(0,n.jsx)(n.Fragment,{});let{boundingRect:r,rects:s}=t;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"EvoAnnotation__parts",onClick:i,children:s.map((e,t)=>(0,n.jsx)("div",{style:{...e},className:"EvoAnnotation__part"},t))})})},tg=e=>{let{sectionElement:t,viewerRef:i,showAnnotatorByClick:s}=e,{bookProps:a}=(0,r.useContext)(Z),{isAnnotationListLoading:o,annotationList:l}=(0,r.useContext)(q),{width:d}=(0,eT.Z)({ref:i}),c=function(e){var t,n,r;arguments.length>1&&void 0!==arguments[1]&&arguments[1];let s=null===(t=i.current)||void 0===t?void 0:t.getBoundingClientRect(),a=(null===(n=i.current)||void 0===n?void 0:n.scrollTop)||0,o=(null===(r=i.current)||void 0===r?void 0:r.scrollLeft)||0;if(!s)return[];let l=Array.from(e.getClientRects()),d=[];for(let e of l){let t={top:e.top+a-s.top,left:e.left+o-s.left,width:e.width,height:e.height};d.push(t)}return d},h=e=>{if(!t||!a.currentSection)return;let i=new _(e,a.currentSection.cfiBase||"").toRange(t);if(!i)return;let n=c(i);return{boundingRect:i.getBoundingClientRect(),rects:n}};if(o||!a.currentSection)return(0,n.jsx)(n.Fragment,{});let u=l.filter(e=>e.sectionIndex===a.currentSectionIndex);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"EvoAnnotation",children:u.map(e=>(0,n.jsx)(tf,{position:h(e.cfi),onClick:t=>{if(!s)return;let i=h(e.cfi);i&&s(t,i.boundingRect,e)},onMouseOver:()=>{},onMouseOut:()=>{}},e.id))},d)})};i(9046);var tm=e=>{let{viewerRef:t,sectionElement:i}=e,{bookProps:s,setBookProps:a}=(0,r.useContext)(Z),{annotationList:o,setAnnotationList:l}=(0,r.useContext)(q),d=(0,r.useRef)(null),[h,u]=r.useState(""),[p,f]=r.useState(),g=(e,i,n)=>{var r,s,a;let o=null===(r=t.current)||void 0===r?void 0:r.getBoundingClientRect(),l=(null==o?void 0:o.right)||window.innerWidth,c=(null==o?void 0:o.height)||window.innerHeight,h=(null===(s=d.current)||void 0===s?void 0:s.clientWidth)||90,u=(null===(a=d.current)||void 0===a?void 0:a.clientHeight)||60,p=e.bottom+5,f=i-h/2;return f<0&&(f=i),f+h>l&&(f=l-h),e.bottom-n>n-e.top+20?e.top>u?p=e.top-u-5:c-e.bottom>u||(p=n+5):c-e.bottom>u||(p=e.top>u?e.top-u:n-u),{top:p,left:f}},m=to(t.current),[v,x]=r.useState(),[b,y]=r.useState();(0,r.useEffect)(()=>{h||(x(void 0),y(void 0))},[h]);let w=async()=>{var e;if(!v||!b)return;let t={id:(0,tp.Z)(),bookId:s.id,cfi:v,bookTitle:s.metadata.title,sectionIndex:s.currentSectionIndex,tocLabel:(null===(e=s.currentTocItem)||void 0===e?void 0:e.label)||"",createdAt:Date.now(),updatedAt:Date.now(),type:"highlight",color:"rgba(255, 226, 143, 1)",text:b};return l(e=>[...e,t]),c.annotationsTable.addAnnotation(t),t};(0,th.Z)("mouseup",e=>{var t;if(!m||m.isCollapsed)return;let i=m.getRangeAt(0),n=g(i.getBoundingClientRect(),e.clientX,e.clientY),r=i.toString(),a=null===(t=s.currentSection)||void 0===t?void 0:t.cfiBase;a&&(x(new _(i,a).toString()),y(r),f(n),u("bySelect"))},{target:t.current}),(0,th.Z)("mousedown",()=>{u("")},{target:t.current}),(0,th.Z)("scroll",()=>{if(h){u("");let e=window.getSelection();e&&e.removeAllRanges()}},{target:t.current});let[N,S]=r.useState(),j=(e,t,i)=>{e.stopPropagation();let n=g(t,e.clientX,e.clientY);x(i.cfi),y(i.text),S(i.id),f(n),u("byClick")},E=async()=>{N&&(l(o.filter(e=>e.id!==N)),await c.annotationsTable.deleteAnnotation(N),S(void 0))};return(0,r.useEffect)(()=>{a(e=>({...e,showAnnotatorByClick:j}))},[]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"EvoAnnotator",ref:d,style:{visibility:""!==h?"visible":"hidden",...p},children:[(0,n.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"bySelect"===h?"block":"none"},onMouseDown:e=>{u(""),w()},children:(0,n.jsx)(tl.Z,{})}),(0,n.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"byClick"===h?"block":"none"},onMouseDown:e=>{e.stopPropagation(),E(),u("")},children:(0,n.jsx)(td.Z,{})}),(0,n.jsx)("div",{className:"EvoAnnotator__icon",children:(0,n.jsx)(tc.Z,{onMouseDown:e=>{e.stopPropagation(),b&&(navigator.clipboard.writeText(b).then(()=>{tu.ZP.success("复制成功！")}).catch(()=>{tu.ZP.error("复制失败，请重试！")}),u(""))}})})]}),i&&(0,n.jsx)(tg,{showAnnotatorByClick:j,viewerRef:t,sectionElement:i})]})},tv=e=>{var t;let{}=e,{readerProps:i,setReaderProps:s}=(0,r.useContext)(f),{bookProps:a,setBookProps:o,epubRef:l}=(0,r.useContext)(Z),d=(0,r.useRef)(null),h=(0,r.useRef)(new Map);function u(){return h.current||(h.current=new Map),h.current}function p(e){return u().get(e)}function g(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];(0,te.flushSync)(()=>{o(t=>({...t,currentSection:e,currentSectionIndex:e.index}))});let i=p(e.index);i&&i.scrollIntoView({block:t?"start":"end"})}function m(e,t){let i=p(e);if(!i)return!1;let n=i.querySelector('[id="'.concat(t.slice(1),'"]'));return!!n&&(n.scrollIntoView({block:"start"}),!0)}let v=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(e instanceof L){g(e,t);return}e.startsWith("#")?m(a.currentSectionIndex,e):_.isCfiString(e)?function(e){var t,i,n;let r=null===(t=l.current)||void 0===t?void 0:t.getSection(e);if(!r)return;(0,te.flushSync)(()=>{o(e=>({...e,currentSection:r,currentSectionIndex:r.index}))});let s=p(r.index);if(!s)return;let a=new _(e).toRange(s),c=null==a?void 0:a.getBoundingClientRect();if((null==c?void 0:c.height)===0)(null==a?void 0:a.startContainer)instanceof HTMLElement&&(null==a||a.startContainer.scrollIntoView({block:"start"}));else{let e=(null===(i=d.current)||void 0===i?void 0:i.scrollTop)||0,t=(null==c?void 0:c.top)||0;null===(n=d.current)||void 0===n||n.scrollTo({top:e+t})}}(e):function(e){var t;let i=null===(t=l.current)||void 0===t?void 0:t.getSection(e);if(!i)return;(0,te.flushSync)(()=>{o(e=>({...e,currentSection:i,currentSectionIndex:i.index}))});let n=e.indexOf("#");if(n>-1){let t=e.slice(n);m(i.index,t)||g(i)}else g(i)}(e)},{run:x}=(0,tn.Z)(()=>{!function(){let e=p(a.currentSectionIndex),t=a.currentSection;if(!e||!(null==t?void 0:t.cfiBase))return;let n=new tr().findStart(e,0,window.innerHeight);if(!n)return;let r=new _(n,null==t?void 0:t.cfiBase).toString();o(e=>({...e,currentCfi:r}));let s={bookId:a.id,filePath:i.ebookPath,cfi:r,percent:0,updatedAt:Date.now()};c.lastReadTable.setLastReadRecord(s,i.ebookPath)}()},{wait:200}),[b,y]=r.useState(0),w=(0,r.useRef)(null);return(0,r.useEffect)(()=>{a.firstSectionLoading||(v(a.moveToTarget),o(e=>({...e,handleMoveToTarget:v})))},[a.firstSectionLoading]),(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{id:"evo-viewer",className:ti().viewer+" dark:custom-dark h-full w-full",ref:d,onScroll:x,onWheel:e=>{var t,i,n,r;if(w.current&&clearTimeout(w.current),d.current){if(0===d.current.scrollTop&&e.deltaY<0&&(y(e=>e-10),b<=-100)){y(0);let e=null===(i=l.current)||void 0===i?void 0:i.getSection(null===(t=a.currentSection)||void 0===t?void 0:t.prevIndex);if(!e)return;g(e,!1)}if(d.current.scrollHeight-d.current.offsetHeight-d.current.scrollTop<3&&e.deltaY>0&&(y(e=>e+10),b>=100)){y(0);let e=null===(r=l.current)||void 0===r?void 0:r.getSection(null===(n=a.currentSection)||void 0===n?void 0:n.nextIndex);if(!e)return;g(e)}w.current=setTimeout(()=>{y(0)},300)}},onClick:e=>{let t=e.target.closest("a[href]");if(!t)return;let i=t.getAttribute("href");i&&(i.startsWith("http")?window.open(i):(e.preventDefault(),v(i)))},children:[(0,n.jsx)("div",{className:"h-2 w-full",children:(0,n.jsx)("div",{style:{width:"".concat(-b,"%")},className:"h-full bg-blue-500"})}),(0,n.jsx)(el,{$cssText:i.settings.userContentStyle||"",children:(0,n.jsx)("div",{id:"evo-content",className:"prose mx-auto dark:prose-invert ",children:null===(t=l.current)||void 0===t?void 0:t.spine.sectionItems.map(e=>(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(e9,{mRef:t=>{let i=u();t?i.set(e.index,t):i.delete(e.index)},section:e,getSectionRef:p,viewerRef:d},e.index)}))})}),(0,n.jsx)("div",{className:"h-2 w-full",children:(0,n.jsx)("div",{style:{width:"".concat(b,"%")},className:"h-full bg-blue-500"})}),(0,n.jsx)(tm,{viewerRef:d,sectionElement:p(a.currentSectionIndex)})]})})},tx=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(f);return(0,r.useEffect)(()=>{let i=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},n=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},r=e=>{e.preventDefault(),document.body.classList.remove(".is-dragging")},s=i=>{var n;i.preventDefault();let r=null===(n=i.dataTransfer)||void 0===n?void 0:n.files;if(r&&r.length>0){let i=r[0];if(!i)return;if(e.ebookUrl&&URL.revokeObjectURL(e.ebookUrl),"application/epub"!==i.type){alert("Only epub files are supported.");return}let n=URL.createObjectURL(i);t(e=>({...e,ebookUrl:n,ebookPath:i.name,ebookFileName:i.name,ebookSize:i.size}))}};return window.addEventListener("dragenter",n),window.addEventListener("dragleave",r),window.addEventListener("dragover",i),window.addEventListener("drop",s),()=>{window.removeEventListener("dragenter",n),window.removeEventListener("dragleave",r),window.removeEventListener("dragover",i),window.removeEventListener("drop",s)}},[]),(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:e3().reader+" dark:bg-neutral-800",children:[(0,n.jsx)(ej,{}),""!==e.showSideBar&&(0,n.jsx)(eQ,{}),!e.isBookLoading&&""===e.ebookUrl&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"w-full",children:(0,n.jsxs)("div",{className:e3().home,children:[(0,n.jsx)("div",{className:e3().title,children:"Evo Reader"}),(0,n.jsx)("div",{className:e3().box,children:(0,n.jsx)(e6,{})})]})})}),!e.isBookLoading&&""!==e.ebookUrl&&(0,n.jsxs)("div",{className:"w-full",children:[(0,n.jsx)(tv,{}),(0,n.jsx)(e1,{})]})]})})},tb=i(3968),ty=JSON.parse('{"viewer":{"prev":"Previous","next":"Next"}}'),tw=JSON.parse('{"viewer":{"prev":"上一章","next":"下一章"}}');function tN(){return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(g,{children:(0,n.jsx)(H,{children:(0,n.jsx)(W,{children:(0,n.jsx)(tx,{})})})})})}tb.ZP.use(e0.Db).init({lng:"zh_CN",debug:!0,resources:{en:{translation:ty},zh_CN:{translation:tw}}})},9046:function(){},6320:function(e){e.exports={ActivityBar:"ActivityBar_ActivityBar__a39dO",icon:"ActivityBar_icon__ThGmC",active:"ActivityBar_active__ahhjF"}},6548:function(e){e.exports={box:"DropFileBox_box__c1WP_",label:"DropFileBox_label___XQ_F"}},4324:function(e){e.exports={reader:"Reader_reader__VQF9J",home:"Reader_home__rrgBc",title:"Reader_title__CVEkX",box:"Reader_box__2HFYP"}},7303:function(e){e.exports={sidebar:"SideBar_sidebar__Xzm7R",header:"SideBar_header___y4sB",title:"SideBar_title__aj588",resizer:"SideBar_resizer__OZ5j0"}},4899:function(e){e.exports={container:"Toc_container__onqy6",node:"Toc_node__EAsE6",arrow:"Toc_arrow__Y2H75",label:"Toc_label__YfigH"}},2198:function(e){e.exports={container:"UserStyle_container__DFSW7"}},9722:function(e){e.exports={footer:"ViewerFooter_footer__HYRq4"}},8463:function(e){e.exports={content:"EpubSection_content__lPCTR"}},92:function(e){e.exports={viewer:"EpubViewer_viewer__jZxew",contentWrapper:"EpubViewer_contentWrapper__E1wAv"}}},function(e){e.O(0,[990,636,971,938,744],function(){return e(e.s=2359)}),_N_E=e.O()}]);
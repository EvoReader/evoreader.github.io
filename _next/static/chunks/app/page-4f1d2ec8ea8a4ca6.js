(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2359:function(e,t,n){Promise.resolve().then(n.bind(n,2185))},2185:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return tm}});var i=n(7437),r=n(2265),s=n(7868);class o{async getAllAnnotations(){try{return await this.table.toArray()}catch(e){console.error(e)}}async getAnnotationsByBookId(e){try{return await this.table.where("bookId").equals(e).toArray()}catch(e){console.error(e)}}async getAnnotationById(e){try{return await this.table.get(e)}catch(e){console.error(e)}}async addAnnotation(e){try{return await this.table.add(e)}catch(e){console.error(e)}}async updateAnnotation(e,t){try{return await this.table.update(e,t)}catch(e){console.error(e)}}async deleteAnnotation(e){try{return await this.table.delete(e)}catch(e){console.error(e)}}constructor(e){this.table=e.table("annotationsTable")}}class a{async getLastReadRecord(e){try{return await this.table.get(e)}catch(e){console.error(e)}}setLastReadRecord(e,t){try{return this.table.put(e,t)}catch(e){console.error(e)}}constructor(e){this.table=e.table("lastReadTable")}}class l{async getSetting(e){try{var t;return null===(t=await this.table.get(e))||void 0===t?void 0:t.value}catch(e){console.error(e)}}async getAllSettings(){try{return(await this.table.toArray()).reduce((e,t)=>{let{key:n,value:i}=t;return{...e,[n]:i}},{})}catch(e){console.error(e)}}setSetting(e,t){try{return this.table.put({key:e,value:t})}catch(e){console.error(e)}}deleteSetting(e){try{return this.table.delete(e)}catch(e){console.error(e)}}constructor(e){this.table=e.table("settingsTable")}}class c extends s.ZP{constructor(){super("EvoReaderDB"),this.version(1).stores({lastReadTable:"filePath, bookId, updatedAt",settingsTable:"key",annotationsTable:"id, bookId"}),this.lastReadTable=new a(this),this.settingsTable=new l(this),this.annotationsTable=new o(this)}}let d=new c;var u=n(2063);let h={settings:{fontsize:16,showSideBar:"",sidebarWidth:300,userContentStyle:"#evo-content {\n  font-size: 16px;\n  line-height: 1.6;\n  max-width: 34em;\n  padding-top: 1em;\n  padding-bottom: 2em;\n}"},isBookLoading:!1,showSideBar:"toc",ebookUrl:"",ebookPath:"",ebookFileName:"",ebookSize:0},p=r.createContext({readerProps:h,setReaderProps:()=>{}}),f=e=>{let{children:t}=e,[n,s]=(0,r.useState)(!1),[o,a]=(0,r.useState)(h);(0,r.useEffect)(()=>{d.settingsTable.getAllSettings().then(e=>{console.log("Get settings from DB:",e),Object.keys(h.settings).forEach(t=>{e&&void 0!==e[t]||(console.log("Setting not found in DB, use default:",t),d.settingsTable.setSetting(t,h.settings[t]))}),a(t=>({...t,settings:{...t.settings,...e}}))}).finally(()=>{s(!0)})},[]);let l=(0,u.Z)(o.settings);(0,r.useEffect)(()=>{if(!l||!n)return;console.log("Reader settings changed:",o.settings,l);let e=o.settings;Object.keys(e).forEach(t=>{l[t]!==e[t]&&(console.log("Update setting:",t,e[t]),d.settingsTable.setSetting(t,e[t]))})},[o.settings,n]),(0,r.useEffect)(()=>{window.electronApi&&window.electronApi.ipcRenderer.on("IPCWEB::FILE-OPENED",e=>{console.log("IPCWEB::FILE-OPENED",e);let{fileData:t,filePath:n,fileSize:i}=e,r=new Blob([t],{type:"application/epub+zip"}),s=URL.createObjectURL(r),o=e.filePath.split(/[/\\]/).pop()||"";a(e=>({...e,ebookUrl:s,ebookPath:n,ebookFileName:o,ebookSize:i}))})},[]);let c=(0,r.useMemo)(()=>({readerProps:o,setReaderProps:a}),[o,a]);return(0,i.jsx)(p.Provider,{value:c,children:n&&t})};var g=n(5245),m=n.n(g),v=n(3571),x=n.n(v),b=n(4436);class y{async open(e){this.zipReader=new b.Mr(new b.Nt(e));let t=await this.zipReader.getEntries();this.entries=new Map(t.map(e=>[e.filename,e]))}async readEntry(e){var t;if(!this.entries)throw Error("Archive not opened");let n=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!n)throw Error("File not found in archive: ".concat(e));if(n.directory)throw Error("File is a directory: ".concat(e));if(!n.getData)throw Error("File cannot be read: ".concat(e));let i=new b.Ek;return await n.getData(i)}async createUrl(e){var t;if(!this.entries)throw Error("Archive not opened");let n=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!n)throw Error("File not found in archive: ".concat(e));if(n.directory)throw Error("File is a directory: ".concat(e));if(!n.getData)throw Error("File cannot be read: ".concat(e));let i=new b.U5,r=await n.getData(i);return URL.createObjectURL(r)}constructor(){this.zipReader=void 0,this.entries=void 0}}function w(e,t){let n;if(!e)throw Error("No Element Provided");return void 0!==e.querySelector?e.querySelector(t):(n=e.getElementsByTagName(t)).length?n[0]:null}function S(e,t){return void 0!==e.querySelector?e.querySelectorAll(t):e.getElementsByTagName(t)}function N(e,t,n){let i,r;if(void 0!==e.querySelector){for(let e in t+="[",n)t+=e+"~='"+n[e]+"'";return t+="]",e.querySelector(t)}if(i=e.getElementsByTagName(t),r=Array.prototype.slice.call(i,0).filter(function(e){for(let t in n)if(e.getAttribute(t)===n[t])return!0;return!1}))return r[0]}function j(e,t){let n=DOMParser;return 65279===e.charCodeAt(0)&&(e=e.slice(1)),new n().parseFromString(e,t)}function E(e,t){switch(m().extname(t)){case".xml":case".opf":case".ncx":default:return j(e,"text/xml");case".xhtml":return j(e,"application/xhtml+xml");case".html":case".htm":return j(e,"text/html")}}function T(e,t,n){let i=[],r=e.childNodes;for(let e=0;e<r.length;e++){let s=r[e];if(1===s.nodeType&&s.nodeName.toLowerCase()===t){if(n)return s;i.push(s)}}if(!n)return i}function C(e,t){let n;if(null!==e&&""!==t)for(n=e.parentNode;1===n.nodeType;){if(n.tagName.toLowerCase()===t)return n;n=n.parentNode}}function k(e){for(var t=[],n=e.childNodes,i=0;i<n.length;i++){let e=n[i];1===e.nodeType&&t.push(e)}return t}class R{parse(e){var t;if(!e)throw Error("Container File Not Found");let n=w(e,"rootfile");if(!n)throw Error("No RootFile Found");this.opfPath=null!==(t=n.getAttribute("full-path"))&&void 0!==t?t:""}constructor(){this.encoding="",this.opfPath=""}}class A{checkType(e){return"string"==typeof e&&A.isCfiString(e)?"string":e&&"object"==typeof e&&("Range"===Object.prototype.toString.call(e).slice(8,-1)||void 0!==e.startContainer)?"range":e&&"object"==typeof e&&void 0!==e.nodeType?"node":!!e&&"object"==typeof e&&e instanceof A&&"EpubCFI"}parse(e){let t,n,i;if("string"!=typeof e)return{spinePos:-1};let r=A.extractCfi(e);return(t=A.getChapterComponent(r))?(this.baseParts=this.parseComponent(t),n=A.getPathComponent(r)||"",this.path=this.parseComponent(n),(i=this.getRange(r))&&(this.isRange=!0,this.start=this.parseComponent(i[0]),this.end=this.parseComponent(i[1])),this.spineIndex=this.baseParts.steps[1].index,this):{spinePos:-1}}parseComponent(e){let t;let n={steps:[],terminal:{offset:null,assertion:null}},i=e.split(":"),r=i[0].split("/");return i.length>1&&(t=i[1],n.terminal=this.parseTerminal(t)),""===r[0]&&r.shift(),n.steps=r.map(e=>this.parseStep(e)),n}parseStep(e){let t,n,i,r,s;if((r=e.match(/\[(.*)\]/))&&r[1]&&(s=r[1]),isNaN(n=parseInt(e)))throw Error("CFI step is not a number");return n%2==0?(t="element",i=n/2-1):(t="text",i=(n-1)/2),{type:t,index:i,id:s||""}}parseTerminal(e){var t;let n,i=null,r=e.match(/\[(.*)\]/);return r&&r[1]?(n=parseInt(e.split("[")[0]),i=r[1]):n=parseInt(e),!isNaN(parseFloat(t=n))&&isFinite(t)||(n=null),{offset:n,assertion:i}}static extractCfi(e){let t="";return 0===e.indexOf("epubcfi(")&&")"===e[e.length-1]&&(t=e.slice(8,e.length-1)),t}static getChapterComponent(e){return e.split("!")[0]}static getPathComponent(e){let t=e.split("!");if(t[1])return t[1].split(",")[0]}getRange(e){let t=e.split(",");if(3===t.length)return[t[1],t[2]]}getCharecterOffsetComponent(e){return e.split(":")[1]||""}joinSteps(e){return e?e.map(function(e){var t="";return"element"===e.type&&(t+=(e.index+1)*2),"text"===e.type&&(t+=1+2*e.index),e.id&&(t+="["+e.id+"]"),t}).join("/"):""}segmentString(e){var t="/";return t+=this.joinSteps(e.steps),e.terminal&&null!=e.terminal.offset&&(t+=":"+e.terminal.offset),e.terminal&&null!=e.terminal.assertion&&(t+="["+e.terminal.assertion+"]"),t}toString(){var e="epubcfi(";return e+=this.segmentString(this.baseParts)+"!"+this.segmentString(this.path),this.isRange&&this.start&&(e+=","+this.segmentString(this.start)),this.isRange&&this.end&&(e+=","+this.segmentString(this.end)),e+=")"}static compare(e,t){let n,i;if(n="string"==typeof e?new A(e):e,i="string"==typeof t?new A(t):t,n.spineIndex>i.spineIndex)return 1;if(n.spineIndex<i.spineIndex)return -1;n.isRange?(r=n.path.steps.concat((null===(l=n.start)||void 0===l?void 0:l.steps)||[]),o=null===(c=n.start)||void 0===c?void 0:c.terminal):(r=n.path.steps,o=n.path.terminal),i.isRange?(s=i.path.steps.concat((null===(d=i.start)||void 0===d?void 0:d.steps)||[]),a=null===(u=i.start)||void 0===u?void 0:u.terminal):(s=i.path.steps,a=i.path.terminal);for(var r,s,o,a,l,c,d,u,h=0;h<r.length;h++){if(!r[h])return -1;if(!s[h]||r[h].index>s[h].index)return 1;if(r[h].index<s[h].index)return -1}if(r.length<s.length)return -1;if((null==o?void 0:o.offset)&&(null==a?void 0:a.offset)){if(o.offset>a.offset)return 1;if(o.offset<a.offset)return -1}return 0}step(e){var t;let n=3===e.nodeType?"text":"element";return{id:null!==(t=e.id)&&void 0!==t?t:"",tagName:e.tagName,type:n,index:this.position(e)}}filteredStep(e,t){var n,i=this.filter(e,t);if(i)return n=3===i.nodeType?"text":"element",{id:i.id,tagName:i.tagName,type:n,index:this.filteredPosition(i,t)}}pathTo(e,t,n){let i={steps:[],terminal:{offset:null,assertion:null}};for(var r,s=e;s&&s.parentNode&&"EVO-HTML"!==s.tagName;)(r=n?this.filteredStep(s,n):this.step(s))&&i.steps.unshift(r),s=s.parentNode;return null!==t&&t>=0&&(i.terminal.offset=t,i.steps.length>0&&"text"!==i.steps[i.steps.length-1].type&&i.steps.push({type:"text",index:0,id:""})),i}equalStep(e,t){return!!e&&!!t&&e.index===t.index&&e.id===t.id&&e.type===t.type}parseFromRange(e,t,n){let i=e.startContainer,r=e.endContainer,s=e.startOffset,o=e.endOffset,a=!1;if(n){var l;a=(null===(l=i.ownerDocument)||void 0===l?void 0:l.querySelector("."+n))!==null}if(t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),e.collapsed)a&&(s=this.patchOffset(i,s,n)),this.path=this.pathTo(i,s,n);else{this.isRange=!0,a&&(s=this.patchOffset(i,s,n)),this.start=this.pathTo(i,s,n),a&&(o=this.patchOffset(r,o,n)),this.end=this.pathTo(r,o,n),this.path={steps:[],terminal:{offset:null,assertion:null}};var c,d=this.start.steps.length;for(c=0;c<d;c++)if(this.equalStep(this.start.steps[c],this.end.steps[c]))c===d-1?this.start.terminal===this.end.terminal&&(this.path.steps.push(this.start.steps[c]),this.isRange=!1):this.path.steps.push(this.start.steps[c]);else break;this.start.steps=this.start.steps.slice(this.path.steps.length),this.end.steps=this.end.steps.slice(this.path.steps.length)}return this}parseFromNode(e,t,n){return t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),this.path=this.pathTo(e,null,n),this}filter(e,t){var n,i,r,s,o,a,l=!1;return(3===e.nodeType?(l=!0,r=e.parentNode,n=null===(a=e.parentNode)||void 0===a?void 0:a.classList.contains(t)):(l=!1,n=e.classList.contains(t)),n&&l)?(s=r.previousSibling,o=r.nextSibling,s&&3===s.nodeType?i=s:o&&3===o.nodeType&&(i=o),i)?i:e:(!n||!!l)&&e}patchOffset(e,t,n){if(3!=e.nodeType)throw Error("Anchor must be a text node");var i=e,r=t;for(e.parentNode.classList.contains(n)&&(i=e.parentNode);i.previousSibling;){if(1===i.previousSibling.nodeType){if(i.previousSibling.classList.contains(n))r+=i.previousSibling.textContent.length;else break}else r+=i.previousSibling.textContent.length;i=i.previousSibling}return r}normalizedMap(e,t,n){var i,r,s,o={},a=-1,l=e.length;for(s=0;s<l;s++)1===(i=e[s].nodeType)&&e[s].classList.contains(n)&&(i=3),s>0&&3===i&&3===r?o[s]=a:t===i&&(a+=1,o[s]=a),r=i;return o}position(e){var t,n;return 1===e.nodeType?((t=e.parentNode.children)||(t=k(e.parentNode)),n=Array.prototype.indexOf.call(t,e)):n=(t=this.textNodes(e.parentNode)).indexOf(e),n}filteredPosition(e,t){var n,i;return 1===e.nodeType?(n=e.parentNode.children,i=this.normalizedMap(n,1,t)):(n=e.parentNode.childNodes,e.parentNode.classList.contains(t)&&(n=(e=e.parentNode).parentNode.childNodes),i=this.normalizedMap(n,3,t)),i[Array.prototype.indexOf.call(n,e)]}stepsToXpath(e){var t=[".","*"];return e.forEach(e=>{var n=e.index+1;e.id?t.push("*[position()="+n+" and @id='"+e.id+"']"):"text"===e.type?t.push("text()["+n+"]"):t.push("*["+n+"]")}),t.join("/")}stepsToQuerySelector(e){var t=["html"];return e.forEach(function(e){var n=e.index+1;e.id?t.push("#"+e.id):"text"===e.type||t.push("*:nth-child("+n+")")}),t.join(">")}textNodes(e,t){return Array.prototype.slice.call(e.childNodes).filter(function(e){return 3===e.nodeType||!!(t&&e.classList.contains(t))})}walkToNode(e,t,n){var i,r,s=document;let o=t;var a=e.length;for(r=0;r<a&&("element"===(i=e[r]).type?o=i.id?s.getElementById(i.id)||o:k(o)[i.index]:"text"===i.type&&(o=this.textNodes(o,n)[i.index]),o);r++);return o}findNode(e,t,n){var i=t||document;return n?this.walkToNode(e,i,n):this.walkToNode(e,i)}fixMiss(e,t,n,i){var r,s,o=this.findNode(e.slice(0,-1),n,i),a=o.childNodes,l=this.normalizedMap(a,3,i),c=e[e.length-1].index;for(let e in l){if(!l.hasOwnProperty(e))return;if(l[e]===c){if(s=(r=a[e]).textContent.length,t>s)t-=s;else{o=1===r.nodeType?r.childNodes[0]:r;break}}}return{container:o,offset:t}}toRange(e){let t,n,i,r,s,o,a,l;if(t=document.createRange(),this.isRange?(n=this.start,o=this.path.steps.concat((null==n?void 0:n.steps)||[]),r=this.findNode(o,e),i=this.end,a=this.path.steps.concat((null==i?void 0:i.steps)||[]),s=this.findNode(a,e)):(n=this.path,o=this.path.steps,r=this.findNode(this.path.steps,e)),!r)return console.log("No startContainer found for",this.toString()),null;try{(null==n?void 0:n.terminal.offset)!=null?t.setStart(r,n.terminal.offset):t.setStart(r,0)}catch(i){l=this.fixMiss(o,null==n?void 0:n.terminal.offset,e),t.setStart(l.container,l.offset)}if(s)try{(null==i?void 0:i.terminal.offset)!=null?t.setEnd(s,i.terminal.offset):t.setEnd(s,0)}catch(e){var c;l=this.fixMiss(a,null===(c=this.end)||void 0===c?void 0:c.terminal.offset,document,needsIgnoring?ignoreClass:null),t.setEnd(l.container,l.offset)}return t}static isCfiString(e){return"string"==typeof e&&0===e.indexOf("epubcfi(")&&")"===e[e.length-1]}static generateChapterComponent(e,t,n){let i="/"+(e+1)*2+"/";return i+=(t+1)*2,n&&(i+="["+n+"]"),i}collapse(e){this.isRange&&(this.isRange=!1,e?(this.path.steps=this.path.steps.concat(this.start.steps),this.path.terminal=this.start.terminal):(this.path.steps=this.path.steps.concat(this.end.steps),this.path.terminal=this.end.terminal))}constructor(e,t,n){if(this.str="",this.baseParts={steps:[],terminal:{offset:null,assertion:null}},this.spineIndex=0,this.isRange=!1,this.path={steps:[],terminal:{offset:null,assertion:null}},this.start=null,this.end=null,!(this instanceof A))return new A(e,t,n);"string"==typeof t&&(this.baseParts=this.parseComponent(t));let i=this.checkType(e);if("string"===i)this.str=e,this.parse(e);else if("range"===i)this.parseFromRange(e,this.baseParts,n),this.str=this.toString();else if("node"===i)this.parseFromNode(e,this.baseParts,n),this.str=this.toString();else if(!e)return this;else throw TypeError("not a valid argument for EpubCFI")}}class _{parse(e,t){if(this.baseDir=m().dirname(t)+"/",!e)throw Error("Package File Not Found");let n=w(e,"metadata");if(!n)throw Error("No Metadata Found");let i=w(e,"manifest");if(!i)throw Error("No Manifest Found");let r=w(e,"spine");if(!r)throw Error("No Spine Found");this.parseManifest(i),this.parseMetadata(n),this.navPath=this.findNavPath(i),this.ncxPath=this.findNcxPath(i,r),this.coverPath=this.findCoverPath(e),this.spineNodeIndex=function(e,t){let n=e.parentNode,i=null==n?void 0:n.childNodes,r=-1;if(i){let t;for(let n=0;n<i.length&&(1===(t=i[n]).nodeType&&r++,t!==e);n++);}return r}(r,0),this.spine=this.parseSpine(r),this.uniqueIdentifier=_.findUniqueIdentifier(e)}parseManifest(e){let t=new Map,n=new Map;e.querySelectorAll("item").forEach(e=>{let i=e.getAttribute("id")||"",r=e.getAttribute("href")||"",s=e.getAttribute("media-type")||"",o=e.getAttribute("media-overlay")||"",a=e.getAttribute("properties")||"",l=m().join(this.baseDir,r),c={id:i,href:r,path:l,type:s,overlay:o,properties:a.length?a.split(" "):[]};i&&t.set(i,c),r&&n.set(r,c)}),this.manifest=t,this.manifestByHref=n}parseMetadata(e){this.metadata.title=_.getElementText(e,"title"),this.metadata.creator=_.getElementText(e,"creator"),this.metadata.description=_.getElementText(e,"description"),this.metadata.pubdate=_.getElementText(e,"date"),this.metadata.publisher=_.getElementText(e,"publisher"),this.metadata.identifier=_.getElementText(e,"identifier"),this.metadata.language=_.getElementText(e,"language"),this.metadata.rights=_.getElementText(e,"rights"),this.metadata.modified_date=_.getPropertyText(e,"dcterms:modified"),this.metadata.layout=_.getPropertyText(e,"rendition:layout"),this.metadata.orientation=_.getPropertyText(e,"rendition:orientation"),this.metadata.flow=_.getPropertyText(e,"rendition:flow"),this.metadata.viewport=_.getPropertyText(e,"rendition:viewport"),this.metadata.media_active_class=_.getPropertyText(e,"media:active-class"),this.metadata.spread=_.getPropertyText(e,"rendition:spread")}parseSpine(e){let t=[];return e.querySelectorAll("itemref").forEach((e,n)=>{var i,r,s,o,a,l,c;let d=null!==(s=e.getAttribute("properties"))&&void 0!==s?s:"",u=null!==(o=e.getAttribute("idref"))&&void 0!==o?o:"",h=null!==(a=null===(i=this.manifest.get(u))||void 0===i?void 0:i.href)&&void 0!==a?a:"",p=null!==(l=null===(r=this.manifest.get(u))||void 0===r?void 0:r.path)&&void 0!==l?l:"",f=A.generateChapterComponent(this.spineNodeIndex,n,u),g={id:null!==(c=e.getAttribute("id"))&&void 0!==c?c:"",idref:u,href:h,path:p,baseDir:this.baseDir,linear:e.getAttribute("linear")||"yes",properties:d.length?d.split(" "):[],index:n,cfiBase:f};t.push(g)}),t}static findUniqueIdentifier(e){let t=e.documentElement.getAttribute("unique-identifier");if(!t)return"";let n=e.getElementById(t);if(!n)return"";if("identifier"===n.localName&&"http://purl.org/dc/elements/1.1/"===n.namespaceURI){var i;return(null===(i=n.childNodes[0].nodeValue)||void 0===i?void 0:i.trim())||""}return""}findNavPath(e){var t;let n=N(e,"item",{properties:"nav"}),i="",r=null!==(t=null==n?void 0:n.getAttribute("href"))&&void 0!==t?t:"";return""!==r&&(i=m().join(this.baseDir,r)),i}findNcxPath(e,t){var n;let i,r=N(e,"item",{"media-type":"application/x-dtbncx+xml"});!r&&(i=t.getAttribute("toc"))&&(r=e.querySelector("#".concat(i)));let s="",o=null!==(n=null==r?void 0:r.getAttribute("href"))&&void 0!==n?n:"";return""!==o&&(s=m().join(this.baseDir,o)),s}findCoverPath(e){var t,n;let i="",r=N(e,"item",{properties:"cover-image"});if(r){let e=null!==(t=r.getAttribute("href"))&&void 0!==t?t:"";if(""!==e)return m().join(this.baseDir,e)}let s=N(e,"meta",{name:"cover"});if(s){let t=s.getAttribute("content"),r=e.getElementById(t),o=null!==(n=null==r?void 0:r.getAttribute("href"))&&void 0!==n?n:"";""!==o&&(i=m().join(this.baseDir,o))}return i}static getElementText(e,t){let n=e.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",t);if(!n||0===n.length)return"";let i=n[0];if(i.childNodes.length){let{nodeValue:e}=i.childNodes[0];if(e)return e}return""}static getPropertyText(e,t){let n=N(e,"meta",{property:t});return n&&n.childNodes.length?n.childNodes[0].nodeValue:""}constructor(){this.baseDir="",this.manifest=new Map,this.manifestByHref=new Map,this.metadata={title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},this.navPath="",this.ncxPath="",this.coverPath="",this.spineNodeIndex=0,this.spine=[],this.uniqueIdentifier=""}}class I{parse(e,t,n){this.baseDir=m().dirname(n)+"/",e.nodeType&&(t?this.toc=this.parseNav(e):this.toc=this.parseNcx(e)),this.length=0,this.unpack(this.toc)}unpack(e){let t;for(let n=0;n<e.length;n++)t=e[n],this.tocFlat.push(t),t.href&&(this.tocByHref[t.href]=n),t.id&&(this.tocById[t.id]=n),this.length+=1,t.children.length>0&&this.unpack(t.children)}get(e){let t;return e?(0===e.indexOf("#")?t=this.tocById[e.substring(1)]:e in this.tocByHref&&(t=this.tocByHref[e]),this.getByIndex(e,t,this.toc)):this.toc}parseNav(e){let t;let n=function(e,t,n){let i;if(void 0!==e.querySelector&&(i=e.querySelector("".concat(t,'[*|type="').concat(n,'"]'))),i&&0!==i.length)return i;i=S(e,t);for(let e=0;e<i.length;e++)if(i[e].getAttributeNS("http://www.idpf.org/2007/ops","type")===n||i[e].getAttribute("epub:type")===n)return i[e]}(e,"nav","toc"),i=n?S(n,"li"):[],r=i.length,s=new Map,o=[];if(!i||0===r)return o;for(let e=0;e<r;e++){let n=this.navItem(i[e]);n&&(s.set(n.id,n),n.parent?(t=s.get(n.parent))&&t.children.push(n):o.push(n))}return o}navItem(e){let t=e.getAttribute("id")||void 0,n=T(e,"a",!0);if(!n)return;let i=n.getAttribute("href")||"";t||(t=i);let r=n.textContent||"",s=C(e,"li"),o="";if(s&&!(o=s.getAttribute("id")||"")){let e=T(s,"a",!0);o=e&&e.getAttribute("href")||""}for(;!o&&s;)if((s=C(s,"li"))&&!(o=s.getAttribute("id")||"")){let e=T(s,"a",!0);o=e&&e.getAttribute("href")||""}return{id:t,path:m().join(this.baseDir,i),href:i,label:r,children:[],parent:o}}parseNcx(e){let t;let n=S(e,"navPoint"),i=n.length,r=new Map,s=[];if(!n||0===i)return s;for(let e=0;e<i;++e)t=this.ncxItem(n[e]),r.set(t.id,t),t.parent?r.get(t.parent).children.push(t):s.push(t);return s}ncxItem(e){var t,n,i,r;let s=e.getAttribute("id")||"",o=w(e,"content"),a=null!==(n=null==o?void 0:o.getAttribute("src"))&&void 0!==n?n:"",l=w(e,"navLabel"),c=null!==(i=null==l?void 0:null===(t=l.textContent)||void 0===t?void 0:t.trim())&&void 0!==i?i:"",d=e.parentNode,u="";return d&&("navPoint"===d.nodeName||"navPoint"===d.nodeName.split(":").slice(-1)[0])&&(u=null!==(r=d.getAttribute("id"))&&void 0!==r?r:""),{id:s,path:m().join(this.baseDir,a),href:a,label:c,children:[],parent:u}}load(e){return e.map(e=>(e.label=e.title,e.children=e.children?this.load(e.children):[],e))}forEach(e){return this.toc.forEach(e)}constructor(){this.baseDir="/",this.toc=[],this.tocFlat=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},this.length=0}}class P{constructor(e,t,n){this.idref=e.idref,this.linear="yes"===e.linear,this.properties=e.properties,this.index=e.index,this.href=e.href,this.path=e.path,this.cfiBase=e.cfiBase,this.nextIndex=t,this.prevIndex=n}}class L{parse(e){this.opfSpine=e,this.length=e.length,e.forEach((t,n)=>{let i=-1,r=-1;if("yes"===t.linear){for(let t=n+1;t<e.length;t++)if("yes"===e[t].linear){i=t;break}for(let t=n-1;t>=0;t--)if("yes"===e[t].linear){r=t;break}}let s=new P(t,i,r);this.sectionItems.push(s),this.sectionItemsByPath[s.path]=s,this.sectionItemsByIdref[s.idref]=s,this.sectionItemsByCfibase[s.cfiBase]=s})}getSection(e){let t=0;if(void 0===e)for(;t<this.sectionItems.length;){let e=this.sectionItems[t];if(e&&e.linear)break;t+=1}else if("string"==typeof e&&A.isCfiString(e)){let t=A.extractCfi(e),n=A.getChapterComponent(t);return this.sectionItemsByCfibase[n]||null}else if("number"==typeof e)t=e;else if("string"==typeof e){var n;let i=e.split("#")[0];t=(null===(n=this.sectionItemsByPath[i])||void 0===n?void 0:n.index)||-1}return this.sectionItems[t]||null}constructor(){this.sectionItems=[],this.sectionItemsByPath={},this.sectionItemsByIdref={},this.sectionItemsByCfibase={},this.opfSpine=void 0,this.length=0}}class B{async parse(e,t){this.manifest=e,this.resources=Array.from(e.values()),this.html=this.resources.filter(e=>"application/xhtml+xml"===e.type||"text/html"===e.type),await Promise.all(Array.from(this.manifest.values()).map(async e=>{if("application/xhtml+xml"!==e.type&&"text/html"!==e.type){let n=await t.createUrl(e.path);this.assets.set(e.path,{...e,url:n})}if("text/css"===e.type){let n=await t.readEntry(e.path);this.css.set(e.path,{...e,text:n})}}))}constructor(){this.manifest=void 0,this.resources=[],this.html=[],this.assets=new Map,this.css=new Map,this.assetsUrls=[],this.cssUrls=[]}}let F="META-INF/container.xml";class D{async parse(e){try{await this.archive.open(e),await this.openContainer(),await this.openOpf(),this.resource.parse(this.opf.manifest,this.archive),await this.loadNavigation(),this.spine.parse(this.opf.spine)}catch(e){return Promise.reject(e)}return this}async openContainer(){let e=E(await this.archive.readEntry(F),F);this.container.parse(e),console.log("container:",this.container)}async openOpf(){let e=this.container.opfPath,t=E(await this.archive.readEntry(e),e);this.opf.parse(t,e),console.log("package:",this.opf)}async loadNavigation(){let e=!0,t=this.opf.navPath;""===t&&(e=!1,t=this.opf.ncxPath);let n=E(await this.archive.readEntry(t),t);this.navigation.parse(n,e,t),console.log("navigation:",this.navigation)}getSection(e){let t=this.spine.getSection(e);return t?(this.currentSectionIndex=t.index,t):null}getNextSection(){let e=this.getSection(this.currentSectionIndex);return e?this.getSection(e.nextIndex):null}getPrevSection(){let e=this.getSection(this.currentSectionIndex);return e?this.getSection(e.prevIndex):null}async loadSection(e){let t=await this.archive.readEntry(e.path);return await this.parseHtmlContent(t,e.path)}async parseHtmlContent(e,t){let n=new DOMParser().parseFromString(e,"application/xhtml+xml");n.querySelectorAll("img").forEach(e=>{let n=e.getAttribute("src");if(!n)return;let i=m().join(t,"..",n),r=this.resource.assets.get(i),s=(null==r?void 0:r.url)||"";e.setAttribute("src",s)}),n.querySelectorAll("image").forEach(e=>{let n=e.getAttribute("xlink:href");if(!n)return;let i=m().join(t,"..",n),r=this.resource.assets.get(i),s=(null==r?void 0:r.url)||"";e.setAttribute("xlink:href",s)});let i=e=>{let n=e.getAttribute("href");if(!n||0===n.indexOf("mailto:")||0===n.indexOf("#"))return;if(n.indexOf("://")>-1){e.setAttribute("target","");return}let i=n.split("#")[1]||"",r=n.split("#")[0],s=m().join(t,"..",r),o=i?"".concat(s,"#").concat(i):s;e.setAttribute("href",o)};n.querySelectorAll("a[href]").forEach(e=>{i(e)});let r=[];n.querySelectorAll("link").forEach(e=>{let n=e.getAttribute("href");if(!n)return;let i=m().join(t,"..",n),s=this.resource.css.get(i);if(!s)return;let o=s.text.replace(/body/g,"evo-body"),a=o.match(/url\((.*?)\)/g);if(a)for(let e of a){let t=null==e?void 0:e.match(/url\((.*?)\)/);if(!t)continue;let n=t[1];console.log("Get css url:",n);let r=m().join(i,"..",n),s=this.resource.assets.get(r),a=(null==s?void 0:s.url)||"";o=o.replace(n,a)}r.push(o)});let s=n.querySelector("body"),o="";if(s){let e=n.createElement("evo-body");e.innerHTML=s.innerHTML,o="<evo-head></evo-head>".concat(e.outerHTML)}return{htmlContent:x().sanitize(o,{ALLOW_UNKNOWN_PROTOCOLS:!0,ADD_TAGS:["evo-html","evo-head","evo-body"]}),cssList:r}}async openPath(e){return await this.archive.readEntry(e)}async openHref(e){let t=this.opf.manifestByHref.get(e);if(!t)throw Error("Invalid epub href");let n=t.path;return await this.archive.readEntry(n)}constructor(){this.archive=new y,this.container=new R,this.opf=new _,this.navigation=new I,this.resource=new B,this.spine=new L,this.currentSectionIndex=0}}var O=n(1969),M=n(4640);let z={id:"",metadata:{title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},currentSection:null,currentSectionIndex:0,currentSectionLoading:!0,moveToTarget:"",currentCfi:"",currentTocItem:null},U=r.createContext({bookProps:z,setBookProps:()=>{},epubRef:{current:null}}),Z=e=>{let{children:t}=e,n=r.useRef(null),[s,o]=(0,r.useState)(z),{readerProps:a,setReaderProps:l}=(0,r.useContext)(p),[c,u]=O.ZP.useNotification(),h=(0,r.useMemo)(()=>({bookProps:s,setBookProps:o,epubRef:n}),[s,o,n]),f=async e=>{let t=await d.lastReadTable.getLastReadRecord(e);if(t)return console.log("setBookProps",t),t;d.lastReadTable.setLastReadRecord({bookId:s.id,filePath:a.ebookPath,cfi:"",percent:0,createdAt:Date.now(),updatedAt:Date.now()},a.ebookPath)};return(0,r.useEffect)(()=>{a.ebookUrl&&(l(e=>({...e,isBookLoading:!0})),o(z),(async()=>{let e=new D,t=await fetch(a.ebookUrl).then(e=>e.blob());await e.parse(t).catch(e=>{throw c.error({message:"打开失败：".concat(a.ebookUrl),description:"".concat(e.stack)}),l(e=>({...e,isBookLoading:!1})),Error(e)}),n.current=e;let i=e.opf.metadata,r=a.ebookFileName+a.ebookSize+i.title+i.pubdate+i.identifier,s=(0,M.Z)(r,M.Z.URL),d=await f(a.ebookPath),u=(null==d?void 0:d.cfi)||"",h=0;if(u){let t=e.getSection(u);h=(null==t?void 0:t.index)||0}return o(e=>({...e,id:s,metadata:i,currentSectionIndex:h,moveToTarget:u})),l(e=>({...e,isBookLoading:!1}))})(),document.title=a.ebookFileName?a.ebookFileName+" - EvoReader":"EvoReader")},[c,a.ebookPath,a.ebookUrl,l]),(0,i.jsxs)(U.Provider,{value:h,children:[u,t]})},H=r.createContext({isAnnotationListLoading:!0,setIsAnnotationListLoading:()=>{},annotationList:[],setAnnotationList:()=>{}}),q=e=>{let{children:t}=e,{bookProps:n}=(0,r.useContext)(U),[s,o]=r.useState([]),[a,l]=r.useState(!0);(0,r.useEffect)(()=>{n.id&&(l(!0),(async()=>{let e=await d.annotationsTable.getAnnotationsByBookId(n.id);e&&e.length>0?o(e):o([]),l(!1)})())},[n.id]);let c=r.useMemo(()=>({isAnnotationListLoading:a,setIsAnnotationListLoading:l,annotationList:s,setAnnotationList:o}),[s,a]);return(0,i.jsx)(H.Provider,{value:c,children:t})};var W=n(4007),V=n(2186),Y=n(9718),X=n(6320),G=n.n(X),K=e=>{let{mRef:t}=e,{readerProps:n,setReaderProps:s}=(0,r.useContext)(p),o=async e=>{if(console.log("input 选择文件：",e.target.files),e.target.files){n.ebookUrl&&URL.revokeObjectURL(n.ebookUrl);let t=e.target.files[0];if(!t)return;let i=URL.createObjectURL(t);s(e=>({...e,ebookUrl:i,ebookPath:t.name,ebookFileName:t.name,ebookSize:t.size}))}},a=async()=>{window.electronApi&&window.electronApi.ipcRenderer.sendMessage("IPCMAIN::ASK-OPEN-FILE")};return(0,i.jsx)(i.Fragment,{children:window.electronApi&&(0,i.jsx)("button",{ref:t,onClick:a,style:{display:"none"}})||(0,i.jsx)("input",{type:"file",accept:".epub",ref:t,onChange:o,style:{display:"none"}})})},Q=n(2175),$=n(4056),J=n(9121),ee=n(2549),et=n(7042),en=n(4769);function ei(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,en.m6)((0,et.W)(t))}let er=J.fC,es=J.xz,eo=J.h_;J.x8;let ea=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,i.jsx)(J.aV,{ref:t,className:ei("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",n),...r})});ea.displayName=J.aV.displayName;let el=r.forwardRef((e,t)=>{let{className:n,children:r,...s}=e;return(0,i.jsxs)(eo,{children:[(0,i.jsx)(ea,{}),(0,i.jsxs)(J.VY,{ref:t,className:ei("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",n),...s,children:[r,(0,i.jsxs)(J.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,i.jsx)(ee.Z,{className:"h-4 w-4"}),(0,i.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});el.displayName=J.VY.displayName;let ec=e=>{let{className:t,...n}=e;return(0,i.jsx)("div",{className:ei("flex flex-col space-y-1.5 text-center sm:text-left",t),...n})};ec.displayName="DialogHeader";let ed=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,i.jsx)(J.Dx,{ref:t,className:ei("text-lg font-semibold leading-none tracking-tight",n),...r})});ed.displayName=J.Dx.displayName,r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,i.jsx)(J.dk,{ref:t,className:ei("text-sm text-muted-foreground",n),...r})}).displayName=J.dk.displayName;var eu=n(6743);let eh=(0,n(9213).j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ep=r.forwardRef((e,t)=>{let{className:n,...r}=e;return(0,i.jsx)(eu.f,{ref:t,className:ei(eh(),n),...r})});ep.displayName=eu.f.displayName;var ef=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),n=(0,r.useRef)(null);return(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:G().ActivityBar,children:[(0,i.jsxs)("div",{className:G().icon,onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()},children:[(0,i.jsx)(W.Z,{}),(0,i.jsx)(K,{mRef:n})]}),(0,i.jsx)("div",{className:G().icon+("toc"===e.showSideBar?" "+G().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"toc"===e.showSideBar?"":"toc"}))},children:(0,i.jsx)(V.Z,{})}),(0,i.jsx)("div",{className:G().icon+("style"===e.showSideBar?" "+G().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"style"===e.showSideBar?"":"style"}))},children:(0,i.jsx)(Y.Z,{})}),(0,i.jsx)("div",{className:G().icon+("annotation"===e.showSideBar?" "+G().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"annotation"===e.showSideBar?"":"annotation"}))},children:(0,i.jsx)(Q.Z,{size:40})}),(0,i.jsxs)(er,{children:[(0,i.jsx)(es,{asChild:!0,children:(0,i.jsx)("div",{className:"mt-auto "+G().icon,children:(0,i.jsx)($.Z,{size:40})})}),(0,i.jsxs)(el,{className:"sm:max-w-[500px]",children:[(0,i.jsx)(ec,{children:(0,i.jsx)(ed,{children:"About EvoReader"})}),(0,i.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,i.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,i.jsx)(ep,{className:"text-right",children:"Version:"}),(0,i.jsx)("span",{className:"col-span-3",children:"v1.0.0-beta"})]}),(0,i.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,i.jsx)(ep,{htmlFor:"username",className:"text-right",children:"Feedback:"}),(0,i.jsx)("span",{className:"col-span-3",children:(0,i.jsx)("a",{href:"https://github.com/EvoReader/EvoReader/issues",className:"text-blue-500",target:"_blank",children:"https://github.com/EvoReader/EvoReader"})})]})]})]})]})]})})},eg=n(2705),em=n(5561),ev=n(8170),ex=n(2398),eb=n(2017),ey=n(1210),ew=n(4899),eS=n.n(ew),eN=n(7303),ej=n.n(eN),eE=e=>{let{title:t="",children:n}=e;return(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:ej().header,children:[(0,i.jsx)("div",{className:ej().title,children:t}),(0,i.jsx)("div",{className:ej().action,children:n})]})})};function eT(e){let{node:t,onClick:n}=e;return t.children&&0===t.children.length?(0,i.jsx)("span",{className:eS().arrow}):(0,i.jsx)("span",{className:eS().arrow,role:"presentation",onClick:n,children:t.isOpen?(0,i.jsx)(ev.Z,{}):(0,i.jsx)(ex.Z,{})})}function eC(e){let{node:t}=e,{bookProps:n,setBookProps:s,epubRef:o}=(0,r.useContext)(U),a=e=>{var t;let n=null===(t=o.current)||void 0===t?void 0:t.getSection(e);if(n){let t="",i=e.indexOf("#");i>-1&&(t=e.slice(i)),s(e=>({...e,currentSectionIndex:n.index,moveToTarget:t}))}};return(0,i.jsxs)("div",{role:"presentation",style:{marginLeft:15*t.level+"px"},className:eS().node,onClick:()=>{t.data.path&&a(t.data.path),t.isOpen||t.open()},children:[(0,i.jsx)(eT,{node:t,onClick:e=>{e.stopPropagation(),t.toggle()}}),(0,i.jsx)("span",{className:eS().label,title:t.data.label,children:t.data.label})]})}var ek=()=>{var e;let{bookProps:t,setBookProps:n,epubRef:s}=(0,r.useContext)(U),[o,a]=(0,r.useState)(null),[l,c]=(0,r.useState)([]),[d,u]=(0,r.useState)(new Map),{ref:h,width:p,height:f}=(0,em.Z)(),g=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!s.current)return;let e=s.current;a(e.navigation.toc),c(e.navigation.tocFlat)},[s]),(0,r.useEffect)(()=>{if(t.currentSectionLoading)return;let e=l.filter(e=>{var n;return e.path.split("#")[0]===(null===(n=t.currentSection)||void 0===n?void 0:n.path)});if(0!==e.length&&(1===e.length&&n(t=>({...t,currentTocItem:e[0]})),e.length>1)){console.log("多个 tocFilterByPath：",e);let n=new Map;e.forEach(e=>{var i;let r=e.href.split("#")[1],s=document.getElementById(r);if(!s)return;let o=new A(s,(null===(i=t.currentSection)||void 0===i?void 0:i.cfiBase)||"");n.set(e.id,o)}),u(n)}},[t.currentSection,l,t.currentSectionLoading]),(0,r.useEffect)(()=>{if(""===t.currentCfi||0===d.size)return;let e="",i=new A(t.currentCfi);for(let[t,n]of d){let r=A.compare(n,i);if(-1===r)e=t;else if(0===r){e=t;break}else if(1===r)break}let r=l.find(t=>t.id===e);r&&n(e=>({...e,currentTocItem:r}))},[t.currentCfi,d]),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(eE,{title:"Table of Contents",children:[(0,i.jsx)(eb.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.openAll()},style:{marginRight:"6px"}}),(0,i.jsx)(ey.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.closeAll()}})]}),o&&(0,i.jsx)("div",{ref:h,className:eS().container,children:(0,i.jsx)(eg.m,{ref:g,selection:null===(e=t.currentTocItem)||void 0===e?void 0:e.id,disableMultiSelection:!0,data:o,indent:20,height:f,width:"100%",onMove:()=>{},renderCursor:()=>null,children:eC})})]})},eR=n(7919),eA=n(2198),e_=n.n(eA),eI=n(8874);let{TextArea:eP}=eR.default;var eL=e=>{let{}=e,{readerProps:t,setReaderProps:n}=(0,r.useContext)(p),[s,o]=(0,r.useState)(t.settings.userContentStyle),{run:a}=(0,eI.Z)(e=>{n(t=>({...t,settings:{...t.settings,userContentStyle:e}}))},{wait:100});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eE,{title:"User Style"}),(0,i.jsx)("div",{className:e_().container,children:(0,i.jsx)(eP,{value:s,onChange:e=>{let t=e.target.value;o(t),a(t)},style:{height:"90vh"}})})]})},eB=n(2067),eF=n.n(eB),eD=e=>{let{annotationData:t,onClickAnnotation:n}=e,r=(null==t?void 0:t.createdAt)?eF()(t.createdAt).format("MMM DD, YYYY, HH:MM"):"null",s=(null==t?void 0:t.text)||"null",o=(null==t?void 0:t.tocLabel)||"null";return(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:"m-2 rounded-lg border transition-all hover:bg-accent cursor-pointer",onClick:()=>{(null==t?void 0:t.cfi)&&n(t.cfi)},children:[(0,i.jsx)("div",{className:"border-b flex justify-between items-center",children:(0,i.jsx)("div",{className:"pl-2",children:r})}),(0,i.jsx)("div",{className:"pt-2 pb-1 px-2",children:s}),(0,i.jsx)("div",{className:"ml-6 pb-2 pr-2 text-xs font-bold text-right text-ellipsis whitespace-nowrap overflow-hidden",children:o})]})})},eO=e=>{let{}=e,{isAnnotationListLoading:t,annotationList:n,setAnnotationList:s}=(0,r.useContext)(H),{setBookProps:o}=(0,r.useContext)(U),a=e=>{o(t=>({...t,moveToTarget:e}))};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eE,{title:"Annotation"}),(0,i.jsx)("div",{className:"h-full overflow-auto",children:n.map(e=>(0,i.jsx)(eD,{annotationData:e,onClickAnnotation:a},e.id))})]})},eM=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),[n,s]=r.useState(e.settings.sidebarWidth||300),{run:o}=(0,eI.Z)(e=>{t(t=>({...t,settings:{...t.settings,sidebarWidth:e}}))},{wait:100}),a=e=>{s(e),o(e)};return(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:ej().sidebar,style:{width:"".concat(n,"px"),minWidth:"200px",maxWidth:"".concat(.45*window.innerWidth,"px")},children:["toc"===e.showSideBar&&!e.isBookLoading&&""!==e.ebookUrl&&(0,i.jsx)(ek,{}),"style"===e.showSideBar&&(0,i.jsx)(eL,{}),"annotation"===e.showSideBar&&(0,i.jsx)(eO,{}),(0,i.jsx)("div",{onMouseDown:e=>{let i=e.clientX,r=e=>{let r=n+e.clientX-i;if(r<200){a(200),r<75&&t(e=>({...e,showSideBar:""}));return}if(r>.45*window.innerWidth){a(.45*window.innerWidth);return}a(r)},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),e.preventDefault()},className:ej().resizer,style:{left:"".concat(n-2,"px")}})]})})},ez=n(230),eU=n(6768);class eZ{page(e,t,n,i){if(e)return this.findStart(e,n,i)}walk(e,t){let n;let i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE&&("img"===e.tagName.toLowerCase()||"image"===e.tagName.toLowerCase())?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),r=i.nextNode();for(;r&&!(n=t(r));)r=i.nextNode();return n}findStart(e,t,n){let i,r;let s=[e],o=e=>{let i=function(e){let t;let n=e.ownerDocument;if(e.nodeType==Node.TEXT_NODE){let i=n.createRange();i.selectNodeContents(e),t=i.getBoundingClientRect()}else t=e.getBoundingClientRect();return t}(e),r=i.top,o=i.bottom;if(r>t&&r<n||o-20>t)return e;s.push(e)};for(;s.length;)if((i=s.shift())&&(r=this.walk(i,o))){if(r.nodeType===Node.TEXT_NODE)return this.findTextStartRange(r,t,n)||r;return r}return e}findTextStartRange(e,t,n){let i;let r=this.splitTextNodeIntoRanges(e);for(let e=0;e<r.length;e++)if((i=r[e]).getBoundingClientRect().top>t)return i.collapse(!0),i}splitTextNodeIntoRanges(e){let t;let n=[],i=(e.textContent||"").trim(),r=e.ownerDocument;for(let s=0;s<i.length;s++)(t=r.createRange()).setStart(e,s),t.setEnd(e,s+1),n.push(t),t=!1;return n}rangePairToCfiPair(e,t){let n=t.start,i=t.end;return n.collapse(!0),i.collapse(!1),{start:n,end:i}}rangeListToCfiList(e,t){let n=[];for(let i=0;i<t.length;i++)n.push(this.rangePairToCfiPair(e,t[i]));return n}axis(e){return e&&(this.isHorizontal="horizontal"===e),this.isHorizontal}constructor(e,t,n){this.isHorizontal=!1,this.direction="ltr",this.isDev=!1,this.isHorizontal="horizontal"===t,this.direction=e||"ltr",this.isDev=n||!1}}var eH=n(9218),eq=n.n(eH),eW=n(9810),eV=n(7137),eY=n(3636),eX=n(5150),eG=function(e){let[t,n]=(0,r.useState)(null),i=(0,r.useRef)(t),s=(0,r.useRef)(!1);return i.current=t,(0,eY.Z)(()=>{let t=(0,eX.getTargetElement)(e,document);if(!t)return;let r=()=>{let e=null;window.getSelection&&((e=window.getSelection())?e.toString():"")&&s.current&&n(e)},o=e=>{if(2===e.button||!window.getSelection)return;i.current&&n(null),s.current=!1;let r=window.getSelection();r&&(r.removeAllRanges(),s.current=t.contains(e.target))};return t.addEventListener("mouseup",r),document.addEventListener("mousedown",o),()=>{t.removeEventListener("mouseup",r),document.removeEventListener("mousedown",o)}},[],e),t},eK=n(7998),eQ=n(4021),e$=n(1552),eJ=n(846),e0=n(7322),e1=n(5618),e2=e=>{let{position:t,onClick:n}=e;if(!t)return(0,i.jsx)(i.Fragment,{});let{boundingRect:r,rects:s}=t;return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)("div",{className:"EvoAnnotation__parts",onClick:n,children:s.map((e,t)=>(0,i.jsx)("div",{style:{...e},className:"EvoAnnotation__part"},t))})})},e4=e=>{let{epubContentRef:t,viewerRef:n,showAnnotatorByClick:s}=e,{bookProps:o,setBookProps:a}=(0,r.useContext)(U),{isAnnotationListLoading:l,annotationList:c,setAnnotationList:d}=(0,r.useContext)(H),{width:u}=(0,em.Z)({ref:n}),h=function(e){var t,i,r;arguments.length>1&&void 0!==arguments[1]&&arguments[1];let s=null===(t=n.current)||void 0===t?void 0:t.getBoundingClientRect(),o=(null===(i=n.current)||void 0===i?void 0:i.scrollTop)||0,a=(null===(r=n.current)||void 0===r?void 0:r.scrollLeft)||0;if(!s)return[];let l=Array.from(e.getClientRects()),c=[];for(let e of l){let t={top:e.top+o-s.top,left:e.left+a-s.left,width:e.width,height:e.height};c.push(t)}return c},p=(0,r.useCallback)(e=>{var n;if(!t.current)return;let i=new A(e,(null===(n=o.currentSection)||void 0===n?void 0:n.cfiBase)||"").toRange(t.current);if(!i)return;let r=h(i);return{boundingRect:i.getBoundingClientRect(),rects:r}},[t.current]),f=(0,r.useMemo)(()=>{if(l||!t.current)return(0,i.jsx)(i.Fragment,{});let e=c.filter(e=>e.sectionIndex===o.currentSectionIndex);return(0,i.jsx)(i.Fragment,{children:e.map(e=>(0,i.jsx)(e2,{position:p(e.cfi),onClick:t=>{let n=p(e.cfi);n&&s(t,n.boundingRect,e)},onMouseOver:()=>{console.log("over")},onMouseOut:()=>{console.log("out")}},e.id))})},[t.current,n.current,c,l,u]);return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)("div",{className:"EvoAnnotation",children:f},u)})};n(9046);var e3=e=>{let{viewerRef:t,epubContentRef:n}=e,{bookProps:s}=(0,r.useContext)(U),{annotationList:o,setAnnotationList:a}=(0,r.useContext)(H),l=(0,r.useRef)(null),[c,u]=r.useState(""),[h,p]=r.useState(),f=(e,n,i)=>{var r,s,o;let a=null===(r=t.current)||void 0===r?void 0:r.getBoundingClientRect();console.log(a);let c=(null==a?void 0:a.right)||window.innerWidth,d=(null==a?void 0:a.height)||window.innerHeight,u=(null===(s=l.current)||void 0===s?void 0:s.clientWidth)||90,h=(null===(o=l.current)||void 0===o?void 0:o.clientHeight)||60,p=e.bottom+5,f=n-u/2;return f<0&&(f=n),f+u>c&&(f=c-u),e.bottom-i>i-e.top+20?e.top>h?p=e.top-h-5:d-e.bottom>h||(p=i+5):d-e.bottom>h||(p=e.top>h?e.top-h:i-h),{top:p,left:f}},g=eG(t.current),[m,v]=r.useState(),[x,b]=r.useState();(0,r.useEffect)(()=>{c||(v(void 0),b(void 0))},[c]);let y=async()=>{var e;if(!m||!x)return;let t={id:(0,e1.Z)(),bookId:s.id,cfi:m,bookTitle:s.metadata.title,sectionIndex:s.currentSectionIndex,tocLabel:(null===(e=s.currentTocItem)||void 0===e?void 0:e.label)||"",createdAt:Date.now(),updatedAt:Date.now(),type:"highlight",color:"rgba(255, 226, 143, 1)",text:x};return a(e=>[...e,t]),d.annotationsTable.addAnnotation(t),t};(0,eJ.Z)("mouseup",e=>{var t;if(!g||g.isCollapsed)return;let n=g.getRangeAt(0),i=f(n.getBoundingClientRect(),e.clientX,e.clientY),r=n.toString();console.log("textSelection:",g,n,r);let o=null===(t=s.currentSection)||void 0===t?void 0:t.cfiBase;if(!o)return;let a=new A(n,o);console.log("cfiRange:",a),v(a.toString()),b(r),p(i),u("bySelect")},{target:t.current}),(0,eJ.Z)("mousedown",()=>{u("")},{target:t.current}),(0,eJ.Z)("scroll",()=>{if(c){u("");let e=window.getSelection();e&&e.removeAllRanges()}},{target:t.current});let[w,S]=r.useState(),N=async()=>{console.log("deleteAnnotation:",w),w&&(a(o.filter(e=>e.id!==w)),await d.annotationsTable.deleteAnnotation(w),S(void 0))};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"EvoAnnotator",ref:l,style:{visibility:""!==c?"visible":"hidden",...h},children:[(0,i.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"bySelect"===c?"block":"none"},onMouseDown:e=>{u(""),y()},children:(0,i.jsx)(eK.Z,{})}),(0,i.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"byClick"===c?"block":"none"},onMouseDown:e=>{e.stopPropagation(),N(),u("")},children:(0,i.jsx)(eQ.Z,{})}),(0,i.jsx)("div",{className:"EvoAnnotator__icon",children:(0,i.jsx)(e$.Z,{onMouseDown:e=>{e.stopPropagation(),x&&(navigator.clipboard.writeText(x).then(()=>{e0.ZP.success("复制成功！")}).catch(()=>{e0.ZP.error("复制失败，请重试！")}),u(""))}})})]}),(0,i.jsx)(e4,{epubContentRef:n,viewerRef:t,showAnnotatorByClick:(e,t,n)=>{e.stopPropagation();let i=f(t,e.clientX,e.clientY);v(n.cfi),b(n.text),S(n.id),p(i),u("byClick")}})]})};function e5(){let e=(0,ez._)(["",""]);return e5=function(){return e},e}let e9=eU.ZP.div(e5(),e=>e.$cssText);var e6=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),{bookProps:n,setBookProps:s,epubRef:o}=(0,r.useContext)(U),a=n.currentSection,l=(0,r.useRef)(null),c=(0,r.useRef)(null),[u,h]=(0,r.useState)(""),[f,g]=(0,r.useState)(""),[m,v]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!o.current)return;console.log("load section:",n.currentSectionIndex),s(e=>({...e,currentSectionLoading:!0}));let e=o.current,t=e.getSection(n.currentSectionIndex);t&&e.loadSection(t).then(e=>(h(e.htmlContent),g(e.cssList.join("\n")),s(e=>({...e,currentSection:t,currentSectionLoading:!1})),e)).catch(e=>{console.error(e)})},[e.ebookUrl,n.currentSectionIndex,o.current,s]);let x=(0,r.useCallback)(e=>{var t;let n=null===(t=l.current)||void 0===t?void 0:t.querySelector('[id="'.concat(e.slice(1),'"]'));n&&(n.scrollIntoView({block:"start"}),s(e=>({...e,moveToTarget:""})))},[s]),b=(0,r.useCallback)(e=>{var t,n,i;if(!c.current)return;let r=new A(e).toRange(c.current),o=null==r?void 0:r.getBoundingClientRect();if(console.log("scrollToCfiTarget:",e,r,o,null===(t=l.current)||void 0===t?void 0:t.scrollTop),(null==o?void 0:o.height)===0)(null==r?void 0:r.startContainer)instanceof HTMLElement&&(null==r||r.startContainer.scrollIntoView({block:"start"}));else{let e=(null===(n=l.current)||void 0===n?void 0:n.scrollTop)||0,t=(null==o?void 0:o.top)||0;null===(i=l.current)||void 0===i||i.scrollTo({top:e+t})}s(e=>({...e,moveToTarget:""}))},[s]);(0,r.useEffect)(()=>{if(n.currentSectionLoading)return;let e=n.moveToTarget;if(""===e){y();return}setTimeout(()=>{var t,i;if(console.log("bookProps.moveToTarget:",e),e.startsWith("#"))x(e);else if(A.isCfiString(e)){let i=null===(t=o.current)||void 0===t?void 0:t.getSection(e);if(!i){console.error("can not find section from cfi"),s(e=>({...e,moveToTarget:""}));return}i.index!==n.currentSectionIndex?s(e=>({...e,currentSectionIndex:i.index})):b(e)}else{let t=null===(i=o.current)||void 0===i?void 0:i.getSection(e);if(!t){console.error("can not find section from href");return}if(t.index!==n.currentSectionIndex){s(e=>({...e,currentSectionIndex:t.index}));let n=e.indexOf("#");if(n>-1){let t=e.slice(n);s(e=>({...e,moveToTarget:t}))}}}},100)},[n.moveToTarget,n.currentSectionLoading]),(0,r.useEffect)(()=>{if(n.currentSectionLoading||!l.current)return;let e=l.current.querySelectorAll("a");return e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let n=e.getAttribute("href");n&&(n.startsWith("http")?window.open(n):s(e=>({...e,moveToTarget:n})))})}),()=>{e.forEach(e=>{e.removeEventListener("click",()=>{})})}},[n.currentSectionLoading]);let y=(0,r.useCallback)(()=>{if(!c.current||!(null==a?void 0:a.cfiBase))return;let t=new eZ().findStart(c.current,0,window.innerHeight);if(!t)return;let i=new A(t,null==a?void 0:a.cfiBase),r=i.toString();console.log("current cfi:",t,i,r),s(e=>({...e,currentCfi:r}));let o={bookId:n.id,filePath:e.ebookPath,cfi:r,percent:0,updatedAt:Date.now()};return d.lastReadTable.setLastReadRecord(o,e.ebookPath),r},[null==a?void 0:a.cfiBase]),{run:w}=(0,eV.Z)(e=>{e.target&&c.current&&y()},{wait:200});(0,r.useEffect)(()=>{let e=e=>{var i,r;if(console.log("keypress",e.key,n.currentSectionIndex),"j"===e.key){let e=null===(i=o.current)||void 0===i?void 0:i.getNextSection();e&&t(t=>({...t,currentSectionIndex:e.index}))}if("k"===e.key){let e=null===(r=o.current)||void 0===r?void 0:r.getPrevSection();e&&t(t=>({...t,currentSectionIndex:e.index}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[o,n.currentSectionIndex,t]);let S=(0,r.useMemo)(()=>(0,i.jsx)(e9,{$cssText:f,children:(0,i.jsx)("evo-html",{dangerouslySetInnerHTML:{__html:u},className:eq().content,ref:c})}),[u,f]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eW.Z,{spinning:n.currentSectionLoading,fullscreen:!0,tip:"Loading Section...",size:"large"}),(0,i.jsx)("div",{className:eq().viewer,onScroll:w,id:"evo-viewer",ref:l,children:(0,i.jsx)(e9,{$cssText:e.settings.userContentStyle||"",children:!n.currentSectionLoading&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:eq().contentWrapper,id:"evo-content",children:S}),(0,i.jsx)(e3,{viewerRef:l,epubContentRef:c})]})})})]})},e7=n(6715),e8=n(1773),te=n(9722),tt=n.n(te),tn=n(251),ti=n(6823);let tr=r.forwardRef((e,t)=>{let{className:n,orientation:r="horizontal",decorative:s=!0,...o}=e;return(0,i.jsx)(ti.f,{ref:t,decorative:s,orientation:r,className:ei("shrink-0 bg-border","horizontal"===r?"h-[1px] w-full":"h-full w-[1px]",n),...o})});tr.displayName=ti.f.displayName;var ts=()=>{var e,t;let{t:n}=(0,tn.$G)(),{bookProps:s,setBookProps:o}=(0,r.useContext)(U),a=null===(e=s.currentSection)||void 0===e?void 0:e.prevIndex,l=null===(t=s.currentSection)||void 0===t?void 0:t.nextIndex;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(tr,{}),(0,i.jsxs)("div",{className:tt().footer,children:[(0,i.jsxs)("button",{onClick:()=>{void 0!==a&&o(e=>({...e,currentSectionIndex:a}))},disabled:void 0===a||a<0,children:[(0,i.jsx)(e7.Z,{className:"mr-1"}),n("viewer.prev")]}),(0,i.jsx)(tr,{orientation:"vertical"}),(0,i.jsxs)("button",{onClick:()=>{void 0!==l&&o(e=>({...e,currentSectionIndex:l}))},disabled:void 0===l||l<0,children:[n("viewer.next"),(0,i.jsx)(e8.Z,{className:"ml-1"})]})]})]})},to=n(4324),ta=n.n(to),tl=n(6548),tc=n.n(tl),td=e=>{let{}=e,t=(0,r.useRef)(null);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:tc().box,onClick:()=>{var e;return null===(e=t.current)||void 0===e?void 0:e.click()},children:[(0,i.jsx)(W.Z,{style:{fontSize:"40px"}}),(0,i.jsxs)("div",{className:tc().label,children:["拖拽文件进窗口 或 ",(0,i.jsx)("span",{style:{color:"#1b88ee"},children:"选择文件"})]}),(0,i.jsx)("div",{children:"支持 epub 格式"})]}),(0,i.jsx)(K,{mRef:t})]})},tu=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p);return(0,r.useEffect)(()=>{let n=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},i=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},r=e=>{e.preventDefault(),document.body.classList.remove(".is-dragging")},s=n=>{var i;n.preventDefault();let r=null===(i=n.dataTransfer)||void 0===i?void 0:i.files;if(r&&r.length>0){let n=r[0];if(console.log("拖拽文件：",n),!n)return;if(e.ebookUrl&&URL.revokeObjectURL(e.ebookUrl),"application/epub"!==n.type){alert("Only epub files are supported.");return}let i=URL.createObjectURL(n);t(e=>({...e,ebookUrl:i,ebookPath:n.name,ebookFileName:n.name,ebookSize:n.size}))}};return window.addEventListener("dragenter",i),window.addEventListener("dragleave",r),window.addEventListener("dragover",n),window.addEventListener("drop",s),()=>{window.removeEventListener("dragenter",i),window.removeEventListener("dragleave",r),window.removeEventListener("dragover",n),window.removeEventListener("drop",s)}},[]),(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:ta().reader,children:[(0,i.jsx)(ef,{}),""!==e.showSideBar&&(0,i.jsx)(eM,{}),!e.isBookLoading&&""===e.ebookUrl&&(0,i.jsx)(i.Fragment,{children:(0,i.jsx)("div",{className:ta().main,children:(0,i.jsxs)("div",{className:ta().home,children:[(0,i.jsx)("div",{className:ta().title,children:"Evo Reader"}),(0,i.jsx)("div",{className:ta().box,children:(0,i.jsx)(td,{})})]})})}),!e.isBookLoading&&""!==e.ebookUrl&&(0,i.jsxs)("div",{className:ta().main,children:[(0,i.jsx)(e6,{}),(0,i.jsx)(ts,{})]})]})})},th=n(3968),tp=JSON.parse('{"viewer":{"prev":"Previous","next":"Next"}}'),tf=JSON.parse('{"viewer":{"prev":"上一章","next":"下一章"}}');th.ZP.use(tn.Db).init({lng:"zh_CN",debug:!0,resources:{en:{translation:tp},zh_CN:{translation:tf}}});var tg=n(4033);function tm(){let e=(0,tg.useRouter)();return(0,r.useEffect)(()=>{let t=e.prefetch;return e.prefetch=async()=>{},()=>{e.prefetch=t}},[e]),(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(f,{children:(0,i.jsx)(Z,{children:(0,i.jsx)(q,{children:(0,i.jsx)(tu,{})})})})})}},9046:function(){},6320:function(e){e.exports={ActivityBar:"ActivityBar_ActivityBar__a39dO",icon:"ActivityBar_icon__ThGmC",active:"ActivityBar_active__ahhjF"}},6548:function(e){e.exports={box:"DropFileBox_box__c1WP_",label:"DropFileBox_label___XQ_F"}},4324:function(e){e.exports={reader:"Reader_reader__VQF9J",main:"Reader_main__KheY_",home:"Reader_home__rrgBc",title:"Reader_title__CVEkX",box:"Reader_box__2HFYP"}},7303:function(e){e.exports={sidebar:"SideBar_sidebar__Xzm7R",header:"SideBar_header___y4sB",title:"SideBar_title__aj588",resizer:"SideBar_resizer__OZ5j0"}},4899:function(e){e.exports={container:"Toc_container__onqy6",node:"Toc_node__EAsE6",arrow:"Toc_arrow__Y2H75",label:"Toc_label__YfigH"}},2198:function(e){e.exports={container:"UserStyle_container__DFSW7"}},9722:function(e){e.exports={footer:"ViewerFooter_footer__HYRq4"}},9218:function(e){e.exports={viewer:"EpubViewer_viewer__BSNYB",contentWrapper:"EpubViewer_contentWrapper__QUez8"}}},function(e){e.O(0,[990,537,971,938,744],function(){return e(e.s=2359)}),_N_E=e.O()}]);
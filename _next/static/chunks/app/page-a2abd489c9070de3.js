(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2359:function(e,t,i){Promise.resolve().then(i.bind(i,2185))},2185:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return tm}});var n=i(7437),r=i(2265),s=i(7868);class a{async getAllAnnotations(){try{return await this.table.toArray()}catch(e){}}async getAnnotationsByBookId(e){try{return await this.table.where("bookId").equals(e).toArray()}catch(e){}}async getAnnotationById(e){try{return await this.table.get(e)}catch(e){}}async addAnnotation(e){try{return await this.table.add(e)}catch(e){}}async updateAnnotation(e,t){try{return await this.table.update(e,t)}catch(e){}}async deleteAnnotation(e){try{return await this.table.delete(e)}catch(e){}}constructor(e){this.table=e.table("annotationsTable")}}class o{async getLastReadRecord(e){try{return await this.table.get(e)}catch(e){}}setLastReadRecord(e,t){try{return this.table.put(e,t)}catch(e){}}constructor(e){this.table=e.table("lastReadTable")}}class l{async getSetting(e){try{var t;return null===(t=await this.table.get(e))||void 0===t?void 0:t.value}catch(e){}}async getAllSettings(){try{return(await this.table.toArray()).reduce((e,t)=>{let{key:i,value:n}=t;return{...e,[i]:n}},{})}catch(e){}}setSetting(e,t){try{return this.table.put({key:e,value:t})}catch(e){}}deleteSetting(e){try{return this.table.delete(e)}catch(e){}}constructor(e){this.table=e.table("settingsTable")}}class d extends s.ZP{constructor(){super("EvoReaderDB"),this.version(1).stores({lastReadTable:"filePath, bookId, updatedAt",settingsTable:"key",annotationsTable:"id, bookId"}),this.lastReadTable=new o(this),this.settingsTable=new l(this),this.annotationsTable=new a(this)}}let c=new d;var u=i(2063);let h={settings:{fontsize:16,showSideBar:"",sidebarWidth:300,userContentStyle:"#evo-content {\n  font-size: 16px;\n  line-height: 1.6;\n  max-width: 34em;\n  padding-top: 1em;\n  padding-bottom: 2em;\n}"},isBookLoading:!1,showSideBar:"toc",ebookUrl:"",ebookPath:"",ebookFileName:"",ebookSize:0},p=r.createContext({readerProps:h,setReaderProps:()=>{}}),f=e=>{let{children:t}=e,[i,s]=(0,r.useState)(!1),[a,o]=(0,r.useState)(h);(0,r.useEffect)(()=>{c.settingsTable.getAllSettings().then(e=>{Object.keys(h.settings).forEach(t=>{e&&void 0!==e[t]||c.settingsTable.setSetting(t,h.settings[t])}),o(t=>({...t,settings:{...t.settings,...e}}))}).finally(()=>{s(!0)})},[]);let l=(0,u.Z)(a.settings);(0,r.useEffect)(()=>{if(!l||!i)return;let e=a.settings;Object.keys(e).forEach(t=>{l[t]!==e[t]&&c.settingsTable.setSetting(t,e[t])})},[a.settings,i]),(0,r.useEffect)(()=>{window.electronApi&&window.electronApi.ipcRenderer.on("IPCWEB::FILE-OPENED",e=>{let{fileData:t,filePath:i,fileSize:n}=e,r=new Blob([t],{type:"application/epub+zip"}),s=URL.createObjectURL(r),a=e.filePath.split(/[/\\]/).pop()||"";o(e=>({...e,ebookUrl:s,ebookPath:i,ebookFileName:a,ebookSize:n}))})},[]);let d=(0,r.useMemo)(()=>({readerProps:a,setReaderProps:o}),[a,o]);return(0,n.jsx)(p.Provider,{value:d,children:i&&t})};var g=i(5245),m=i.n(g),v=i(3571),x=i.n(v),b=i(4436);class y{async open(e){this.zipReader=new b.Mr(new b.Nt(e));let t=await this.zipReader.getEntries();this.entries=new Map(t.map(e=>[e.filename,e]))}async readEntry(e){var t;if(!this.entries)throw Error("Archive not opened");let i=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!i)throw Error("File not found in archive: ".concat(e));if(i.directory)throw Error("File is a directory: ".concat(e));if(!i.getData)throw Error("File cannot be read: ".concat(e));let n=new b.Ek;return await i.getData(n)}async createUrl(e){var t;if(!this.entries)throw Error("Archive not opened");let i=null===(t=this.entries)||void 0===t?void 0:t.get(e);if(!i)throw Error("File not found in archive: ".concat(e));if(i.directory)throw Error("File is a directory: ".concat(e));if(!i.getData)throw Error("File cannot be read: ".concat(e));let n=new b.U5,r=await i.getData(n);return URL.createObjectURL(r)}constructor(){this.zipReader=void 0,this.entries=void 0}}function w(e,t){let i;if(!e)throw Error("No Element Provided");return void 0!==e.querySelector?e.querySelector(t):(i=e.getElementsByTagName(t)).length?i[0]:null}function N(e,t){return void 0!==e.querySelector?e.querySelectorAll(t):e.getElementsByTagName(t)}function S(e,t,i){let n,r;if(void 0!==e.querySelector){for(let e in t+="[",i)t+=e+"~='"+i[e]+"'";return t+="]",e.querySelector(t)}if(n=e.getElementsByTagName(t),r=Array.prototype.slice.call(n,0).filter(function(e){for(let t in i)if(e.getAttribute(t)===i[t])return!0;return!1}))return r[0]}function j(e,t){let i=DOMParser;return 65279===e.charCodeAt(0)&&(e=e.slice(1)),new i().parseFromString(e,t)}function E(e,t){switch(m().extname(t)){case".xml":case".opf":case".ncx":default:return j(e,"text/xml");case".xhtml":return j(e,"application/xhtml+xml");case".html":case".htm":return j(e,"text/html")}}function T(e,t,i){let n=[],r=e.childNodes;for(let e=0;e<r.length;e++){let s=r[e];if(1===s.nodeType&&s.nodeName.toLowerCase()===t){if(i)return s;n.push(s)}}if(!i)return n}function C(e,t){let i;if(null!==e&&""!==t)for(i=e.parentNode;1===i.nodeType;){if(i.tagName.toLowerCase()===t)return i;i=i.parentNode}}function k(e){for(var t=[],i=e.childNodes,n=0;n<i.length;n++){let e=i[n];1===e.nodeType&&t.push(e)}return t}class R{parse(e){var t;if(!e)throw Error("Container File Not Found");let i=w(e,"rootfile");if(!i)throw Error("No RootFile Found");this.opfPath=null!==(t=i.getAttribute("full-path"))&&void 0!==t?t:""}constructor(){this.encoding="",this.opfPath=""}}class A{checkType(e){return"string"==typeof e&&A.isCfiString(e)?"string":e&&"object"==typeof e&&("Range"===Object.prototype.toString.call(e).slice(8,-1)||void 0!==e.startContainer)?"range":e&&"object"==typeof e&&void 0!==e.nodeType?"node":!!e&&"object"==typeof e&&e instanceof A&&"EpubCFI"}parse(e){let t,i,n;if("string"!=typeof e)return{spinePos:-1};let r=A.extractCfi(e);return(t=A.getChapterComponent(r))?(this.baseParts=this.parseComponent(t),i=A.getPathComponent(r)||"",this.path=this.parseComponent(i),(n=this.getRange(r))&&(this.isRange=!0,this.start=this.parseComponent(n[0]),this.end=this.parseComponent(n[1])),this.spineIndex=this.baseParts.steps[1].index,this):{spinePos:-1}}parseComponent(e){let t;let i={steps:[],terminal:{offset:null,assertion:null}},n=e.split(":"),r=n[0].split("/");return n.length>1&&(t=n[1],i.terminal=this.parseTerminal(t)),""===r[0]&&r.shift(),i.steps=r.map(e=>this.parseStep(e)),i}parseStep(e){let t,i,n,r,s;if((r=e.match(/\[(.*)\]/))&&r[1]&&(s=r[1]),isNaN(i=parseInt(e)))throw Error("CFI step is not a number");return i%2==0?(t="element",n=i/2-1):(t="text",n=(i-1)/2),{type:t,index:n,id:s||""}}parseTerminal(e){var t;let i,n=null,r=e.match(/\[(.*)\]/);return r&&r[1]?(i=parseInt(e.split("[")[0]),n=r[1]):i=parseInt(e),!isNaN(parseFloat(t=i))&&isFinite(t)||(i=null),{offset:i,assertion:n}}static extractCfi(e){let t="";return 0===e.indexOf("epubcfi(")&&")"===e[e.length-1]&&(t=e.slice(8,e.length-1)),t}static getChapterComponent(e){return e.split("!")[0]}static getPathComponent(e){let t=e.split("!");if(t[1])return t[1].split(",")[0]}getRange(e){let t=e.split(",");if(3===t.length)return[t[1],t[2]]}getCharecterOffsetComponent(e){return e.split(":")[1]||""}joinSteps(e){return e?e.map(function(e){var t="";return"element"===e.type&&(t+=(e.index+1)*2),"text"===e.type&&(t+=1+2*e.index),e.id&&(t+="["+e.id+"]"),t}).join("/"):""}segmentString(e){var t="/";return t+=this.joinSteps(e.steps),e.terminal&&null!=e.terminal.offset&&(t+=":"+e.terminal.offset),e.terminal&&null!=e.terminal.assertion&&(t+="["+e.terminal.assertion+"]"),t}toString(){var e="epubcfi(";return e+=this.segmentString(this.baseParts)+"!"+this.segmentString(this.path),this.isRange&&this.start&&(e+=","+this.segmentString(this.start)),this.isRange&&this.end&&(e+=","+this.segmentString(this.end)),e+=")"}static compare(e,t){let i,n;if(i="string"==typeof e?new A(e):e,n="string"==typeof t?new A(t):t,i.spineIndex>n.spineIndex)return 1;if(i.spineIndex<n.spineIndex)return -1;i.isRange?(r=i.path.steps.concat((null===(l=i.start)||void 0===l?void 0:l.steps)||[]),a=null===(d=i.start)||void 0===d?void 0:d.terminal):(r=i.path.steps,a=i.path.terminal),n.isRange?(s=n.path.steps.concat((null===(c=n.start)||void 0===c?void 0:c.steps)||[]),o=null===(u=n.start)||void 0===u?void 0:u.terminal):(s=n.path.steps,o=n.path.terminal);for(var r,s,a,o,l,d,c,u,h=0;h<r.length;h++){if(!r[h])return -1;if(!s[h]||r[h].index>s[h].index)return 1;if(r[h].index<s[h].index)return -1}if(r.length<s.length)return -1;if((null==a?void 0:a.offset)&&(null==o?void 0:o.offset)){if(a.offset>o.offset)return 1;if(a.offset<o.offset)return -1}return 0}step(e){var t;let i=3===e.nodeType?"text":"element";return{id:null!==(t=e.id)&&void 0!==t?t:"",tagName:e.tagName,type:i,index:this.position(e)}}filteredStep(e,t){var i,n=this.filter(e,t);if(n)return i=3===n.nodeType?"text":"element",{id:n.id,tagName:n.tagName,type:i,index:this.filteredPosition(n,t)}}pathTo(e,t,i){let n={steps:[],terminal:{offset:null,assertion:null}};for(var r,s=e;s&&s.parentNode&&"EVO-HTML"!==s.tagName;)(r=i?this.filteredStep(s,i):this.step(s))&&n.steps.unshift(r),s=s.parentNode;return null!==t&&t>=0&&(n.terminal.offset=t,n.steps.length>0&&"text"!==n.steps[n.steps.length-1].type&&n.steps.push({type:"text",index:0,id:""})),n}equalStep(e,t){return!!e&&!!t&&e.index===t.index&&e.id===t.id&&e.type===t.type}parseFromRange(e,t,i){let n=e.startContainer,r=e.endContainer,s=e.startOffset,a=e.endOffset,o=!1;if(i){var l;o=(null===(l=n.ownerDocument)||void 0===l?void 0:l.querySelector("."+i))!==null}if(t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),e.collapsed)o&&(s=this.patchOffset(n,s,i)),this.path=this.pathTo(n,s,i);else{this.isRange=!0,o&&(s=this.patchOffset(n,s,i)),this.start=this.pathTo(n,s,i),o&&(a=this.patchOffset(r,a,i)),this.end=this.pathTo(r,a,i),this.path={steps:[],terminal:{offset:null,assertion:null}};var d,c=this.start.steps.length;for(d=0;d<c;d++)if(this.equalStep(this.start.steps[d],this.end.steps[d]))d===c-1?this.start.terminal===this.end.terminal&&(this.path.steps.push(this.start.steps[d]),this.isRange=!1):this.path.steps.push(this.start.steps[d]);else break;this.start.steps=this.start.steps.slice(this.path.steps.length),this.end.steps=this.end.steps.slice(this.path.steps.length)}return this}parseFromNode(e,t,i){return t.steps.length>1&&(this.spineIndex=this.baseParts.steps[1].index),this.path=this.pathTo(e,null,i),this}filter(e,t){var i,n,r,s,a,o,l=!1;return(3===e.nodeType?(l=!0,r=e.parentNode,i=null===(o=e.parentNode)||void 0===o?void 0:o.classList.contains(t)):(l=!1,i=e.classList.contains(t)),i&&l)?(s=r.previousSibling,a=r.nextSibling,s&&3===s.nodeType?n=s:a&&3===a.nodeType&&(n=a),n)?n:e:(!i||!!l)&&e}patchOffset(e,t,i){if(3!=e.nodeType)throw Error("Anchor must be a text node");var n=e,r=t;for(e.parentNode.classList.contains(i)&&(n=e.parentNode);n.previousSibling;){if(1===n.previousSibling.nodeType){if(n.previousSibling.classList.contains(i))r+=n.previousSibling.textContent.length;else break}else r+=n.previousSibling.textContent.length;n=n.previousSibling}return r}normalizedMap(e,t,i){var n,r,s,a={},o=-1,l=e.length;for(s=0;s<l;s++)1===(n=e[s].nodeType)&&e[s].classList.contains(i)&&(n=3),s>0&&3===n&&3===r?a[s]=o:t===n&&(o+=1,a[s]=o),r=n;return a}position(e){var t,i;return 1===e.nodeType?((t=e.parentNode.children)||(t=k(e.parentNode)),i=Array.prototype.indexOf.call(t,e)):i=(t=this.textNodes(e.parentNode)).indexOf(e),i}filteredPosition(e,t){var i,n;return 1===e.nodeType?(i=e.parentNode.children,n=this.normalizedMap(i,1,t)):(i=e.parentNode.childNodes,e.parentNode.classList.contains(t)&&(i=(e=e.parentNode).parentNode.childNodes),n=this.normalizedMap(i,3,t)),n[Array.prototype.indexOf.call(i,e)]}stepsToXpath(e){var t=[".","*"];return e.forEach(e=>{var i=e.index+1;e.id?t.push("*[position()="+i+" and @id='"+e.id+"']"):"text"===e.type?t.push("text()["+i+"]"):t.push("*["+i+"]")}),t.join("/")}stepsToQuerySelector(e){var t=["html"];return e.forEach(function(e){var i=e.index+1;e.id?t.push("#"+e.id):"text"===e.type||t.push("*:nth-child("+i+")")}),t.join(">")}textNodes(e,t){return Array.prototype.slice.call(e.childNodes).filter(function(e){return 3===e.nodeType||!!(t&&e.classList.contains(t))})}walkToNode(e,t,i){var n,r,s=document;let a=t;var o=e.length;for(r=0;r<o&&("element"===(n=e[r]).type?a=n.id?s.getElementById(n.id)||a:k(a)[n.index]:"text"===n.type&&(a=this.textNodes(a,i)[n.index]),a);r++);return a}findNode(e,t,i){var n=t||document;return i?this.walkToNode(e,n,i):this.walkToNode(e,n)}fixMiss(e,t,i,n){var r,s,a=this.findNode(e.slice(0,-1),i,n),o=a.childNodes,l=this.normalizedMap(o,3,n),d=e[e.length-1].index;for(let e in l){if(!l.hasOwnProperty(e))return;if(l[e]===d){if(s=(r=o[e]).textContent.length,t>s)t-=s;else{a=1===r.nodeType?r.childNodes[0]:r;break}}}return{container:a,offset:t}}toRange(e){let t,i,n,r,s,a,o,l;if(t=document.createRange(),this.isRange?(i=this.start,a=this.path.steps.concat((null==i?void 0:i.steps)||[]),r=this.findNode(a,e),n=this.end,o=this.path.steps.concat((null==n?void 0:n.steps)||[]),s=this.findNode(o,e)):(i=this.path,a=this.path.steps,r=this.findNode(this.path.steps,e)),!r)return null;try{(null==i?void 0:i.terminal.offset)!=null?t.setStart(r,i.terminal.offset):t.setStart(r,0)}catch(n){l=this.fixMiss(a,null==i?void 0:i.terminal.offset,e),t.setStart(l.container,l.offset)}if(s)try{(null==n?void 0:n.terminal.offset)!=null?t.setEnd(s,n.terminal.offset):t.setEnd(s,0)}catch(e){var d;l=this.fixMiss(o,null===(d=this.end)||void 0===d?void 0:d.terminal.offset,document,needsIgnoring?ignoreClass:null),t.setEnd(l.container,l.offset)}return t}static isCfiString(e){return"string"==typeof e&&0===e.indexOf("epubcfi(")&&")"===e[e.length-1]}static generateChapterComponent(e,t,i){let n="/"+(e+1)*2+"/";return n+=(t+1)*2,i&&(n+="["+i+"]"),n}collapse(e){this.isRange&&(this.isRange=!1,e?(this.path.steps=this.path.steps.concat(this.start.steps),this.path.terminal=this.start.terminal):(this.path.steps=this.path.steps.concat(this.end.steps),this.path.terminal=this.end.terminal))}constructor(e,t,i){if(this.str="",this.baseParts={steps:[],terminal:{offset:null,assertion:null}},this.spineIndex=0,this.isRange=!1,this.path={steps:[],terminal:{offset:null,assertion:null}},this.start=null,this.end=null,!(this instanceof A))return new A(e,t,i);"string"==typeof t&&(this.baseParts=this.parseComponent(t));let n=this.checkType(e);if("string"===n)this.str=e,this.parse(e);else if("range"===n)this.parseFromRange(e,this.baseParts,i),this.str=this.toString();else if("node"===n)this.parseFromNode(e,this.baseParts,i),this.str=this.toString();else if(!e)return this;else throw TypeError("not a valid argument for EpubCFI")}}class _{parse(e,t){if(this.baseDir=m().dirname(t)+"/",!e)throw Error("Package File Not Found");let i=w(e,"metadata");if(!i)throw Error("No Metadata Found");let n=w(e,"manifest");if(!n)throw Error("No Manifest Found");let r=w(e,"spine");if(!r)throw Error("No Spine Found");this.parseManifest(n),this.parseMetadata(i),this.navPath=this.findNavPath(n),this.ncxPath=this.findNcxPath(n,r),this.coverPath=this.findCoverPath(e),this.spineNodeIndex=function(e,t){let i=e.parentNode,n=null==i?void 0:i.childNodes,r=-1;if(n){let t;for(let i=0;i<n.length&&(1===(t=n[i]).nodeType&&r++,t!==e);i++);}return r}(r,0),this.spine=this.parseSpine(r),this.uniqueIdentifier=_.findUniqueIdentifier(e)}parseManifest(e){let t=new Map,i=new Map;e.querySelectorAll("item").forEach(e=>{let n=e.getAttribute("id")||"",r=e.getAttribute("href")||"",s=e.getAttribute("media-type")||"",a=e.getAttribute("media-overlay")||"",o=e.getAttribute("properties")||"",l=m().join(this.baseDir,r),d={id:n,href:r,path:l,type:s,overlay:a,properties:o.length?o.split(" "):[]};n&&t.set(n,d),r&&i.set(r,d)}),this.manifest=t,this.manifestByHref=i}parseMetadata(e){this.metadata.title=_.getElementText(e,"title"),this.metadata.creator=_.getElementText(e,"creator"),this.metadata.description=_.getElementText(e,"description"),this.metadata.pubdate=_.getElementText(e,"date"),this.metadata.publisher=_.getElementText(e,"publisher"),this.metadata.identifier=_.getElementText(e,"identifier"),this.metadata.language=_.getElementText(e,"language"),this.metadata.rights=_.getElementText(e,"rights"),this.metadata.modified_date=_.getPropertyText(e,"dcterms:modified"),this.metadata.layout=_.getPropertyText(e,"rendition:layout"),this.metadata.orientation=_.getPropertyText(e,"rendition:orientation"),this.metadata.flow=_.getPropertyText(e,"rendition:flow"),this.metadata.viewport=_.getPropertyText(e,"rendition:viewport"),this.metadata.media_active_class=_.getPropertyText(e,"media:active-class"),this.metadata.spread=_.getPropertyText(e,"rendition:spread")}parseSpine(e){let t=[];return e.querySelectorAll("itemref").forEach((e,i)=>{var n,r,s,a,o,l,d;let c=null!==(s=e.getAttribute("properties"))&&void 0!==s?s:"",u=null!==(a=e.getAttribute("idref"))&&void 0!==a?a:"",h=null!==(o=null===(n=this.manifest.get(u))||void 0===n?void 0:n.href)&&void 0!==o?o:"",p=null!==(l=null===(r=this.manifest.get(u))||void 0===r?void 0:r.path)&&void 0!==l?l:"",f=A.generateChapterComponent(this.spineNodeIndex,i,u),g={id:null!==(d=e.getAttribute("id"))&&void 0!==d?d:"",idref:u,href:h,path:p,baseDir:this.baseDir,linear:e.getAttribute("linear")||"yes",properties:c.length?c.split(" "):[],index:i,cfiBase:f};t.push(g)}),t}static findUniqueIdentifier(e){let t=e.documentElement.getAttribute("unique-identifier");if(!t)return"";let i=e.getElementById(t);if(!i)return"";if("identifier"===i.localName&&"http://purl.org/dc/elements/1.1/"===i.namespaceURI){var n;return(null===(n=i.childNodes[0].nodeValue)||void 0===n?void 0:n.trim())||""}return""}findNavPath(e){var t;let i=S(e,"item",{properties:"nav"}),n="",r=null!==(t=null==i?void 0:i.getAttribute("href"))&&void 0!==t?t:"";return""!==r&&(n=m().join(this.baseDir,r)),n}findNcxPath(e,t){var i;let n,r=S(e,"item",{"media-type":"application/x-dtbncx+xml"});!r&&(n=t.getAttribute("toc"))&&(r=e.querySelector("#".concat(n)));let s="",a=null!==(i=null==r?void 0:r.getAttribute("href"))&&void 0!==i?i:"";return""!==a&&(s=m().join(this.baseDir,a)),s}findCoverPath(e){var t,i;let n="",r=S(e,"item",{properties:"cover-image"});if(r){let e=null!==(t=r.getAttribute("href"))&&void 0!==t?t:"";if(""!==e)return m().join(this.baseDir,e)}let s=S(e,"meta",{name:"cover"});if(s){let t=s.getAttribute("content"),r=e.getElementById(t),a=null!==(i=null==r?void 0:r.getAttribute("href"))&&void 0!==i?i:"";""!==a&&(n=m().join(this.baseDir,a))}return n}static getElementText(e,t){let i=e.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",t);if(!i||0===i.length)return"";let n=i[0];if(n.childNodes.length){let{nodeValue:e}=n.childNodes[0];if(e)return e}return""}static getPropertyText(e,t){let i=S(e,"meta",{property:t});return i&&i.childNodes.length?i.childNodes[0].nodeValue:""}constructor(){this.baseDir="",this.manifest=new Map,this.manifestByHref=new Map,this.metadata={title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},this.navPath="",this.ncxPath="",this.coverPath="",this.spineNodeIndex=0,this.spine=[],this.uniqueIdentifier=""}}class I{parse(e,t,i){this.baseDir=m().dirname(i)+"/",e.nodeType&&(t?this.toc=this.parseNav(e):this.toc=this.parseNcx(e)),this.length=0,this.unpack(this.toc)}unpack(e){let t;for(let i=0;i<e.length;i++)t=e[i],this.tocFlat.push(t),t.href&&(this.tocByHref[t.href]=i),t.id&&(this.tocById[t.id]=i),this.length+=1,t.children.length>0&&this.unpack(t.children)}get(e){let t;return e?(0===e.indexOf("#")?t=this.tocById[e.substring(1)]:e in this.tocByHref&&(t=this.tocByHref[e]),this.getByIndex(e,t,this.toc)):this.toc}parseNav(e){let t;let i=function(e,t,i){let n;if(void 0!==e.querySelector&&(n=e.querySelector("".concat(t,'[*|type="').concat(i,'"]'))),n&&0!==n.length)return n;n=N(e,t);for(let e=0;e<n.length;e++)if(n[e].getAttributeNS("http://www.idpf.org/2007/ops","type")===i||n[e].getAttribute("epub:type")===i)return n[e]}(e,"nav","toc"),n=i?N(i,"li"):[],r=n.length,s=new Map,a=[];if(!n||0===r)return a;for(let e=0;e<r;e++){let i=this.navItem(n[e]);i&&(s.set(i.id,i),i.parent?(t=s.get(i.parent))&&t.children.push(i):a.push(i))}return a}navItem(e){let t=e.getAttribute("id")||void 0,i=T(e,"a",!0);if(!i)return;let n=i.getAttribute("href")||"";t||(t=n);let r=i.textContent||"",s=C(e,"li"),a="";if(s&&!(a=s.getAttribute("id")||"")){let e=T(s,"a",!0);a=e&&e.getAttribute("href")||""}for(;!a&&s;)if((s=C(s,"li"))&&!(a=s.getAttribute("id")||"")){let e=T(s,"a",!0);a=e&&e.getAttribute("href")||""}return{id:t,path:m().join(this.baseDir,n),href:n,label:r,children:[],parent:a}}parseNcx(e){let t;let i=N(e,"navPoint"),n=i.length,r=new Map,s=[];if(!i||0===n)return s;for(let e=0;e<n;++e)t=this.ncxItem(i[e]),r.set(t.id,t),t.parent?r.get(t.parent).children.push(t):s.push(t);return s}ncxItem(e){var t,i,n,r;let s=e.getAttribute("id")||"",a=w(e,"content"),o=null!==(i=null==a?void 0:a.getAttribute("src"))&&void 0!==i?i:"",l=w(e,"navLabel"),d=null!==(n=null==l?void 0:null===(t=l.textContent)||void 0===t?void 0:t.trim())&&void 0!==n?n:"",c=e.parentNode,u="";return c&&("navPoint"===c.nodeName||"navPoint"===c.nodeName.split(":").slice(-1)[0])&&(u=null!==(r=c.getAttribute("id"))&&void 0!==r?r:""),{id:s,path:m().join(this.baseDir,o),href:o,label:d,children:[],parent:u}}load(e){return e.map(e=>(e.label=e.title,e.children=e.children?this.load(e.children):[],e))}forEach(e){return this.toc.forEach(e)}constructor(){this.baseDir="/",this.toc=[],this.tocFlat=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},this.length=0}}class P{constructor(e,t,i){this.idref=e.idref,this.linear="yes"===e.linear,this.properties=e.properties,this.index=e.index,this.href=e.href,this.path=e.path,this.cfiBase=e.cfiBase,this.nextIndex=t,this.prevIndex=i}}class L{parse(e){this.opfSpine=e,this.length=e.length,e.forEach((t,i)=>{let n=-1,r=-1;if("yes"===t.linear){for(let t=i+1;t<e.length;t++)if("yes"===e[t].linear){n=t;break}for(let t=i-1;t>=0;t--)if("yes"===e[t].linear){r=t;break}}let s=new P(t,n,r);this.sectionItems.push(s),this.sectionItemsByPath[s.path]=s,this.sectionItemsByIdref[s.idref]=s,this.sectionItemsByCfibase[s.cfiBase]=s})}getSection(e){let t=0;if(void 0===e)for(;t<this.sectionItems.length;){let e=this.sectionItems[t];if(e&&e.linear)break;t+=1}else if("string"==typeof e&&A.isCfiString(e)){let t=A.extractCfi(e),i=A.getChapterComponent(t);return this.sectionItemsByCfibase[i]||null}else if("number"==typeof e)t=e;else if("string"==typeof e){var i;let n=e.split("#")[0];t=(null===(i=this.sectionItemsByPath[n])||void 0===i?void 0:i.index)||-1}return this.sectionItems[t]||null}constructor(){this.sectionItems=[],this.sectionItemsByPath={},this.sectionItemsByIdref={},this.sectionItemsByCfibase={},this.opfSpine=void 0,this.length=0}}class B{async parse(e,t){this.manifest=e,this.resources=Array.from(e.values()),this.html=this.resources.filter(e=>"application/xhtml+xml"===e.type||"text/html"===e.type),await Promise.all(Array.from(this.manifest.values()).map(async e=>{if("application/xhtml+xml"!==e.type&&"text/html"!==e.type){let i=await t.createUrl(e.path);this.assets.set(e.path,{...e,url:i})}if("text/css"===e.type){let i=await t.readEntry(e.path);this.css.set(e.path,{...e,text:i})}}))}constructor(){this.manifest=void 0,this.resources=[],this.html=[],this.assets=new Map,this.css=new Map,this.assetsUrls=[],this.cssUrls=[]}}let F="META-INF/container.xml";class D{async parse(e){try{await this.archive.open(e),await this.openContainer(),await this.openOpf(),this.resource.parse(this.opf.manifest,this.archive),await this.loadNavigation(),this.spine.parse(this.opf.spine)}catch(e){return Promise.reject(e)}return this}async openContainer(){let e=E(await this.archive.readEntry(F),F);this.container.parse(e)}async openOpf(){let e=this.container.opfPath,t=E(await this.archive.readEntry(e),e);this.opf.parse(t,e)}async loadNavigation(){let e=!0,t=this.opf.navPath;""===t&&(e=!1,t=this.opf.ncxPath);let i=E(await this.archive.readEntry(t),t);this.navigation.parse(i,e,t)}getSection(e){let t=this.spine.getSection(e);return t?(this.currentSectionIndex=t.index,t):null}getNextSection(){let e=this.getSection(this.currentSectionIndex);return e?this.getSection(e.nextIndex):null}getPrevSection(){let e=this.getSection(this.currentSectionIndex);return e?this.getSection(e.prevIndex):null}async loadSection(e){let t=await this.archive.readEntry(e.path);return await this.parseHtmlContent(t,e.path)}async parseHtmlContent(e,t){let i=new DOMParser().parseFromString(e,"application/xhtml+xml");i.querySelectorAll("img").forEach(e=>{let i=e.getAttribute("src");if(!i)return;let n=m().join(t,"..",i),r=this.resource.assets.get(n),s=(null==r?void 0:r.url)||"";e.setAttribute("src",s)}),i.querySelectorAll("image").forEach(e=>{let i=e.getAttribute("xlink:href");if(!i)return;let n=m().join(t,"..",i),r=this.resource.assets.get(n),s=(null==r?void 0:r.url)||"";e.setAttribute("xlink:href",s)});let n=e=>{let i=e.getAttribute("href");if(!i||0===i.indexOf("mailto:")||0===i.indexOf("#"))return;if(i.indexOf("://")>-1){e.setAttribute("target","");return}let n=i.split("#")[1]||"",r=i.split("#")[0],s=m().join(t,"..",r),a=n?"".concat(s,"#").concat(n):s;e.setAttribute("href",a)};i.querySelectorAll("a[href]").forEach(e=>{n(e)});let r=[];i.querySelectorAll("link").forEach(e=>{let i=e.getAttribute("href");if(!i)return;let n=m().join(t,"..",i),s=this.resource.css.get(n);if(!s)return;let a=s.text.replace(/body/g,"evo-body"),o=a.match(/url\((.*?)\)/g);if(o)for(let e of o){let t=null==e?void 0:e.match(/url\((.*?)\)/);if(!t)continue;let i=t[1],r=m().join(n,"..",i),s=this.resource.assets.get(r),o=(null==s?void 0:s.url)||"";a=a.replace(i,o)}r.push(a)});let s=i.querySelector("body"),a="";if(s){let e=i.createElement("evo-body");e.innerHTML=s.innerHTML,a="<evo-head></evo-head>".concat(e.outerHTML)}return{htmlContent:x().sanitize(a,{ALLOW_UNKNOWN_PROTOCOLS:!0,ADD_TAGS:["evo-html","evo-head","evo-body"]}),cssList:r}}async openPath(e){return await this.archive.readEntry(e)}async openHref(e){let t=this.opf.manifestByHref.get(e);if(!t)throw Error("Invalid epub href");let i=t.path;return await this.archive.readEntry(i)}constructor(){this.archive=new y,this.container=new R,this.opf=new _,this.navigation=new I,this.resource=new B,this.spine=new L,this.currentSectionIndex=0}}var O=i(1969),M=i(4640);let z={id:"",metadata:{title:"",creator:"",description:"",pubdate:"",publisher:"",identifier:"",language:"",rights:"",modified_date:"",layout:"",orientation:"",flow:"",viewport:"",media_active_class:"",spread:""},currentSection:null,currentSectionIndex:0,currentSectionLoading:!0,moveToTarget:"",currentCfi:"",currentTocItem:null},U=r.createContext({bookProps:z,setBookProps:()=>{},epubRef:{current:null}}),Z=e=>{let{children:t}=e,i=r.useRef(null),[s,a]=(0,r.useState)(z),{readerProps:o,setReaderProps:l}=(0,r.useContext)(p),[d,u]=O.ZP.useNotification(),h=(0,r.useMemo)(()=>({bookProps:s,setBookProps:a,epubRef:i}),[s,a,i]),f=async e=>{let t=await c.lastReadTable.getLastReadRecord(e);if(t)return t;c.lastReadTable.setLastReadRecord({bookId:s.id,filePath:o.ebookPath,cfi:"",percent:0,createdAt:Date.now(),updatedAt:Date.now()},o.ebookPath)};return(0,r.useEffect)(()=>{o.ebookUrl&&(l(e=>({...e,isBookLoading:!0})),a(z),(async()=>{let e=new D,t=await fetch(o.ebookUrl).then(e=>e.blob());await e.parse(t).catch(e=>{throw d.error({message:"打开失败：".concat(o.ebookUrl),description:"".concat(e.stack)}),l(e=>({...e,isBookLoading:!1})),Error(e)}),i.current=e;let n=e.opf.metadata,r=o.ebookFileName+o.ebookSize+n.title+n.pubdate+n.identifier,s=(0,M.Z)(r,M.Z.URL),c=await f(o.ebookPath),u=(null==c?void 0:c.cfi)||"",h=0;if(u){let t=e.getSection(u);h=(null==t?void 0:t.index)||0}return a(e=>({...e,id:s,metadata:n,currentSectionIndex:h,moveToTarget:u})),l(e=>({...e,isBookLoading:!1}))})(),document.title=o.ebookFileName?o.ebookFileName+" - EvoReader":"EvoReader")},[d,o.ebookPath,o.ebookUrl,l]),(0,n.jsxs)(U.Provider,{value:h,children:[u,t]})},H=r.createContext({isAnnotationListLoading:!0,setIsAnnotationListLoading:()=>{},annotationList:[],setAnnotationList:()=>{}}),q=e=>{let{children:t}=e,{bookProps:i}=(0,r.useContext)(U),[s,a]=r.useState([]),[o,l]=r.useState(!0);(0,r.useEffect)(()=>{i.id&&(l(!0),(async()=>{let e=await c.annotationsTable.getAnnotationsByBookId(i.id);e&&e.length>0?a(e):a([]),l(!1)})())},[i.id]);let d=r.useMemo(()=>({isAnnotationListLoading:o,setIsAnnotationListLoading:l,annotationList:s,setAnnotationList:a}),[s,o]);return(0,n.jsx)(H.Provider,{value:d,children:t})};var W=i(4007),V=i(2186),Y=i(9718),X=i(6320),K=i.n(X),Q=e=>{let{mRef:t}=e,{readerProps:i,setReaderProps:s}=(0,r.useContext)(p),a=async e=>{if(e.target.files){i.ebookUrl&&URL.revokeObjectURL(i.ebookUrl);let t=e.target.files[0];if(!t)return;let n=URL.createObjectURL(t);s(e=>({...e,ebookUrl:n,ebookPath:t.name,ebookFileName:t.name,ebookSize:t.size}))}},o=async()=>{window.electronApi&&window.electronApi.ipcRenderer.sendMessage("IPCMAIN::ASK-OPEN-FILE")};return(0,n.jsx)(n.Fragment,{children:window.electronApi&&(0,n.jsx)("button",{ref:t,onClick:o,style:{display:"none"}})||(0,n.jsx)("input",{type:"file",accept:".epub",ref:t,onChange:a,style:{display:"none"}})})},$=i(2175),G=i(4056),J=i(9121),ee=i(2549),et=i(7042),ei=i(4769);function en(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return(0,ei.m6)((0,et.W)(t))}let er=J.fC,es=J.xz,ea=J.h_;J.x8;let eo=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(J.aV,{ref:t,className:en("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",i),...r})});eo.displayName=J.aV.displayName;let el=r.forwardRef((e,t)=>{let{className:i,children:r,...s}=e;return(0,n.jsxs)(ea,{children:[(0,n.jsx)(eo,{}),(0,n.jsxs)(J.VY,{ref:t,className:en("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",i),...s,children:[r,(0,n.jsxs)(J.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,n.jsx)(ee.Z,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});el.displayName=J.VY.displayName;let ed=e=>{let{className:t,...i}=e;return(0,n.jsx)("div",{className:en("flex flex-col space-y-1.5 text-center sm:text-left",t),...i})};ed.displayName="DialogHeader";let ec=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(J.Dx,{ref:t,className:en("text-lg font-semibold leading-none tracking-tight",i),...r})});ec.displayName=J.Dx.displayName,r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(J.dk,{ref:t,className:en("text-sm text-muted-foreground",i),...r})}).displayName=J.dk.displayName;var eu=i(6743);let eh=(0,i(9213).j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ep=r.forwardRef((e,t)=>{let{className:i,...r}=e;return(0,n.jsx)(eu.f,{ref:t,className:en(eh(),i),...r})});ep.displayName=eu.f.displayName;var ef=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),i=(0,r.useRef)(null);return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:K().ActivityBar,children:[(0,n.jsxs)("div",{className:K().icon,onClick:()=>{var e;return null===(e=i.current)||void 0===e?void 0:e.click()},children:[(0,n.jsx)(W.Z,{}),(0,n.jsx)(Q,{mRef:i})]}),(0,n.jsx)("div",{className:K().icon+("toc"===e.showSideBar?" "+K().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"toc"===e.showSideBar?"":"toc"}))},children:(0,n.jsx)(V.Z,{})}),(0,n.jsx)("div",{className:K().icon+("style"===e.showSideBar?" "+K().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"style"===e.showSideBar?"":"style"}))},children:(0,n.jsx)(Y.Z,{})}),(0,n.jsx)("div",{className:K().icon+("annotation"===e.showSideBar?" "+K().active:""),onClick:e=>{e.preventDefault(),t(e=>({...e,showSideBar:"annotation"===e.showSideBar?"":"annotation"}))},children:(0,n.jsx)($.Z,{size:40})}),(0,n.jsxs)(er,{children:[(0,n.jsx)(es,{asChild:!0,children:(0,n.jsx)("div",{className:"mt-auto "+K().icon,children:(0,n.jsx)(G.Z,{size:40})})}),(0,n.jsxs)(el,{className:"sm:max-w-[500px]",children:[(0,n.jsx)(ed,{children:(0,n.jsx)(ec,{children:"About EvoReader"})}),(0,n.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,n.jsx)(ep,{className:"text-right",children:"Version:"}),(0,n.jsx)("span",{className:"col-span-3",children:"v1.0.0-beta"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,n.jsx)(ep,{htmlFor:"username",className:"text-right",children:"Feedback:"}),(0,n.jsx)("span",{className:"col-span-3",children:(0,n.jsx)("a",{href:"https://github.com/EvoReader/EvoReader/issues",className:"text-blue-500",target:"_blank",children:"https://github.com/EvoReader/EvoReader"})})]})]})]})]})]})})},eg=i(2705),em=i(5561),ev=i(8170),ex=i(2398),eb=i(2017),ey=i(1210),ew=i(4899),eN=i.n(ew),eS=i(7303),ej=i.n(eS),eE=e=>{let{title:t="",children:i}=e;return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:ej().header,children:[(0,n.jsx)("div",{className:ej().title,children:t}),(0,n.jsx)("div",{className:ej().action,children:i})]})})};function eT(e){let{node:t,onClick:i}=e;return t.children&&0===t.children.length?(0,n.jsx)("span",{className:eN().arrow}):(0,n.jsx)("span",{className:eN().arrow,role:"presentation",onClick:i,children:t.isOpen?(0,n.jsx)(ev.Z,{}):(0,n.jsx)(ex.Z,{})})}function eC(e){let{node:t}=e,{bookProps:i,setBookProps:s,epubRef:a}=(0,r.useContext)(U),o=e=>{var t;let i=null===(t=a.current)||void 0===t?void 0:t.getSection(e);if(i){let t="",n=e.indexOf("#");n>-1&&(t=e.slice(n)),s(e=>({...e,currentSectionIndex:i.index,moveToTarget:t}))}};return(0,n.jsxs)("div",{role:"presentation",style:{marginLeft:15*t.level+"px"},className:eN().node,onClick:()=>{t.data.path&&o(t.data.path),t.isOpen||t.open()},children:[(0,n.jsx)(eT,{node:t,onClick:e=>{e.stopPropagation(),t.toggle()}}),(0,n.jsx)("span",{className:eN().label,title:t.data.label,children:t.data.label})]})}var ek=()=>{var e;let{bookProps:t,setBookProps:i,epubRef:s}=(0,r.useContext)(U),[a,o]=(0,r.useState)(null),[l,d]=(0,r.useState)([]),[c,u]=(0,r.useState)(new Map),{ref:h,width:p,height:f}=(0,em.Z)(),g=(0,r.useRef)(null);return(0,r.useEffect)(()=>{if(!s.current)return;let e=s.current;o(e.navigation.toc),d(e.navigation.tocFlat)},[s]),(0,r.useEffect)(()=>{if(t.currentSectionLoading)return;let e=l.filter(e=>{var i;return e.path.split("#")[0]===(null===(i=t.currentSection)||void 0===i?void 0:i.path)});if(0!==e.length&&(1===e.length&&i(t=>({...t,currentTocItem:e[0]})),e.length>1)){let i=new Map;e.forEach(e=>{var n;let r=e.href.split("#")[1],s=document.getElementById(r);if(!s)return;let a=new A(s,(null===(n=t.currentSection)||void 0===n?void 0:n.cfiBase)||"");i.set(e.id,a)}),u(i)}},[t.currentSection,l,t.currentSectionLoading]),(0,r.useEffect)(()=>{if(""===t.currentCfi||0===c.size)return;let e="",n=new A(t.currentCfi);for(let[t,i]of c){let r=A.compare(i,n);if(-1===r)e=t;else if(0===r){e=t;break}else if(1===r)break}let r=l.find(t=>t.id===e);r&&i(e=>({...e,currentTocItem:r}))},[t.currentCfi,c]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(eE,{title:"Table of Contents",children:[(0,n.jsx)(eb.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.openAll()},style:{marginRight:"6px"}}),(0,n.jsx)(ey.Z,{onClick:()=>{var e;null===(e=g.current)||void 0===e||e.closeAll()}})]}),a&&(0,n.jsx)("div",{ref:h,className:eN().container,children:(0,n.jsx)(eg.m,{ref:g,selection:null===(e=t.currentTocItem)||void 0===e?void 0:e.id,disableMultiSelection:!0,data:a,indent:20,height:f,width:"100%",onMove:()=>{},renderCursor:()=>null,children:eC})})]})},eR=i(7919),eA=i(2198),e_=i.n(eA),eI=i(8874);let{TextArea:eP}=eR.default;var eL=e=>{let{}=e,{readerProps:t,setReaderProps:i}=(0,r.useContext)(p),[s,a]=(0,r.useState)(t.settings.userContentStyle),{run:o}=(0,eI.Z)(e=>{i(t=>({...t,settings:{...t.settings,userContentStyle:e}}))},{wait:100});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eE,{title:"User Style"}),(0,n.jsx)("div",{className:e_().container,children:(0,n.jsx)(eP,{value:s,onChange:e=>{let t=e.target.value;a(t),o(t)},style:{height:"90vh"}})})]})},eB=i(2067),eF=i.n(eB),eD=e=>{let{annotationData:t,onClickAnnotation:i}=e,r=(null==t?void 0:t.createdAt)?eF()(t.createdAt).format("MMM DD, YYYY, HH:MM"):"null",s=(null==t?void 0:t.text)||"null",a=(null==t?void 0:t.tocLabel)||"null";return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:"m-2 rounded-lg border transition-all hover:bg-accent cursor-pointer",onClick:()=>{(null==t?void 0:t.cfi)&&i(t.cfi)},children:[(0,n.jsx)("div",{className:"border-b flex justify-between items-center",children:(0,n.jsx)("div",{className:"pl-2",children:r})}),(0,n.jsx)("div",{className:"pt-2 pb-1 px-2",children:s}),(0,n.jsx)("div",{className:"ml-6 pb-2 pr-2 text-xs font-bold text-right text-ellipsis whitespace-nowrap overflow-hidden",children:a})]})})},eO=e=>{let{}=e,{isAnnotationListLoading:t,annotationList:i,setAnnotationList:s}=(0,r.useContext)(H),{setBookProps:a}=(0,r.useContext)(U),o=e=>{a(t=>({...t,moveToTarget:e}))};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eE,{title:"Annotation"}),(0,n.jsx)("div",{className:"h-full overflow-auto",children:i.map(e=>(0,n.jsx)(eD,{annotationData:e,onClickAnnotation:o},e.id))})]})},eM=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),[i,s]=r.useState(e.settings.sidebarWidth||300),{run:a}=(0,eI.Z)(e=>{t(t=>({...t,settings:{...t.settings,sidebarWidth:e}}))},{wait:100}),o=e=>{s(e),a(e)};return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:ej().sidebar,style:{width:"".concat(i,"px"),minWidth:"200px",maxWidth:"".concat(.45*window.innerWidth,"px")},children:["toc"===e.showSideBar&&!e.isBookLoading&&""!==e.ebookUrl&&(0,n.jsx)(ek,{}),"style"===e.showSideBar&&(0,n.jsx)(eL,{}),"annotation"===e.showSideBar&&(0,n.jsx)(eO,{}),(0,n.jsx)("div",{onMouseDown:e=>{let n=e.clientX,r=e=>{let r=i+e.clientX-n;if(r<200){o(200),r<75&&t(e=>({...e,showSideBar:""}));return}if(r>.45*window.innerWidth){o(.45*window.innerWidth);return}o(r)},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),e.preventDefault()},className:ej().resizer,style:{left:"".concat(i-2,"px")}})]})})},ez=i(230),eU=i(6768);class eZ{page(e,t,i,n){if(e)return this.findStart(e,i,n)}walk(e,t){let i;let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE&&("img"===e.tagName.toLowerCase()||"image"===e.tagName.toLowerCase())?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),r=n.nextNode();for(;r&&!(i=t(r));)r=n.nextNode();return i}findStart(e,t,i){let n,r;let s=[e],a=e=>{let n=function(e){let t;let i=e.ownerDocument;if(e.nodeType==Node.TEXT_NODE){let n=i.createRange();n.selectNodeContents(e),t=n.getBoundingClientRect()}else t=e.getBoundingClientRect();return t}(e),r=n.top,a=n.bottom;if(r>t&&r<i||a-20>t)return e;s.push(e)};for(;s.length;)if((n=s.shift())&&(r=this.walk(n,a))){if(r.nodeType===Node.TEXT_NODE)return this.findTextStartRange(r,t,i)||r;return r}return e}findTextStartRange(e,t,i){let n;let r=this.splitTextNodeIntoRanges(e);for(let e=0;e<r.length;e++)if((n=r[e]).getBoundingClientRect().top>t)return n.collapse(!0),n}splitTextNodeIntoRanges(e){let t;let i=[],n=(e.textContent||"").trim(),r=e.ownerDocument;for(let s=0;s<n.length;s++)(t=r.createRange()).setStart(e,s),t.setEnd(e,s+1),i.push(t),t=!1;return i}rangePairToCfiPair(e,t){let i=t.start,n=t.end;return i.collapse(!0),n.collapse(!1),{start:i,end:n}}rangeListToCfiList(e,t){let i=[];for(let n=0;n<t.length;n++)i.push(this.rangePairToCfiPair(e,t[n]));return i}axis(e){return e&&(this.isHorizontal="horizontal"===e),this.isHorizontal}constructor(e,t,i){this.isHorizontal=!1,this.direction="ltr",this.isDev=!1,this.isHorizontal="horizontal"===t,this.direction=e||"ltr",this.isDev=i||!1}}var eH=i(9218),eq=i.n(eH),eW=i(9810),eV=i(7137),eY=i(3636),eX=i(5150),eK=function(e){let[t,i]=(0,r.useState)(null),n=(0,r.useRef)(t),s=(0,r.useRef)(!1);return n.current=t,(0,eY.Z)(()=>{let t=(0,eX.getTargetElement)(e,document);if(!t)return;let r=()=>{let e=null;window.getSelection&&((e=window.getSelection())?e.toString():"")&&s.current&&i(e)},a=e=>{if(2===e.button||!window.getSelection)return;n.current&&i(null),s.current=!1;let r=window.getSelection();r&&(r.removeAllRanges(),s.current=t.contains(e.target))};return t.addEventListener("mouseup",r),document.addEventListener("mousedown",a),()=>{t.removeEventListener("mouseup",r),document.removeEventListener("mousedown",a)}},[],e),t},eQ=i(7998),e$=i(4021),eG=i(1552),eJ=i(846),e0=i(7322),e1=i(5618),e2=e=>{let{position:t,onClick:i}=e;if(!t)return(0,n.jsx)(n.Fragment,{});let{boundingRect:r,rects:s}=t;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"EvoAnnotation__parts",onClick:i,children:s.map((e,t)=>(0,n.jsx)("div",{style:{...e},className:"EvoAnnotation__part"},t))})})},e4=e=>{let{epubContentRef:t,viewerRef:i,showAnnotatorByClick:s}=e,{bookProps:a,setBookProps:o}=(0,r.useContext)(U),{isAnnotationListLoading:l,annotationList:d,setAnnotationList:c}=(0,r.useContext)(H),{width:u}=(0,em.Z)({ref:i}),h=function(e){var t,n,r;arguments.length>1&&void 0!==arguments[1]&&arguments[1];let s=null===(t=i.current)||void 0===t?void 0:t.getBoundingClientRect(),a=(null===(n=i.current)||void 0===n?void 0:n.scrollTop)||0,o=(null===(r=i.current)||void 0===r?void 0:r.scrollLeft)||0;if(!s)return[];let l=Array.from(e.getClientRects()),d=[];for(let e of l){let t={top:e.top+a-s.top,left:e.left+o-s.left,width:e.width,height:e.height};d.push(t)}return d},p=(0,r.useCallback)(e=>{var i;if(!t.current)return;let n=new A(e,(null===(i=a.currentSection)||void 0===i?void 0:i.cfiBase)||"").toRange(t.current);if(!n)return;let r=h(n);return{boundingRect:n.getBoundingClientRect(),rects:r}},[t.current]),f=(0,r.useMemo)(()=>{if(l||!t.current)return(0,n.jsx)(n.Fragment,{});let e=d.filter(e=>e.sectionIndex===a.currentSectionIndex);return(0,n.jsx)(n.Fragment,{children:e.map(e=>(0,n.jsx)(e2,{position:p(e.cfi),onClick:t=>{let i=p(e.cfi);i&&s(t,i.boundingRect,e)},onMouseOver:()=>{},onMouseOut:()=>{}},e.id))})},[t.current,i.current,d,l,u]);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:"EvoAnnotation",children:f},u)})};i(9046);var e3=e=>{let{viewerRef:t,epubContentRef:i}=e,{bookProps:s}=(0,r.useContext)(U),{annotationList:a,setAnnotationList:o}=(0,r.useContext)(H),l=(0,r.useRef)(null),[d,u]=r.useState(""),[h,p]=r.useState(),f=(e,i,n)=>{var r,s,a;let o=null===(r=t.current)||void 0===r?void 0:r.getBoundingClientRect(),d=(null==o?void 0:o.right)||window.innerWidth,c=(null==o?void 0:o.height)||window.innerHeight,u=(null===(s=l.current)||void 0===s?void 0:s.clientWidth)||90,h=(null===(a=l.current)||void 0===a?void 0:a.clientHeight)||60,p=e.bottom+5,f=i-u/2;return f<0&&(f=i),f+u>d&&(f=d-u),e.bottom-n>n-e.top+20?e.top>h?p=e.top-h-5:c-e.bottom>h||(p=n+5):c-e.bottom>h||(p=e.top>h?e.top-h:n-h),{top:p,left:f}},g=eK(t.current),[m,v]=r.useState(),[x,b]=r.useState();(0,r.useEffect)(()=>{d||(v(void 0),b(void 0))},[d]);let y=async()=>{var e;if(!m||!x)return;let t={id:(0,e1.Z)(),bookId:s.id,cfi:m,bookTitle:s.metadata.title,sectionIndex:s.currentSectionIndex,tocLabel:(null===(e=s.currentTocItem)||void 0===e?void 0:e.label)||"",createdAt:Date.now(),updatedAt:Date.now(),type:"highlight",color:"rgba(255, 226, 143, 1)",text:x};return o(e=>[...e,t]),c.annotationsTable.addAnnotation(t),t};(0,eJ.Z)("mouseup",e=>{var t;if(!g||g.isCollapsed)return;let i=g.getRangeAt(0),n=f(i.getBoundingClientRect(),e.clientX,e.clientY),r=i.toString(),a=null===(t=s.currentSection)||void 0===t?void 0:t.cfiBase;a&&(v(new A(i,a).toString()),b(r),p(n),u("bySelect"))},{target:t.current}),(0,eJ.Z)("mousedown",()=>{u("")},{target:t.current}),(0,eJ.Z)("scroll",()=>{if(d){u("");let e=window.getSelection();e&&e.removeAllRanges()}},{target:t.current});let[w,N]=r.useState(),S=async()=>{w&&(o(a.filter(e=>e.id!==w)),await c.annotationsTable.deleteAnnotation(w),N(void 0))};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"EvoAnnotator",ref:l,style:{visibility:""!==d?"visible":"hidden",...h},children:[(0,n.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"bySelect"===d?"block":"none"},onMouseDown:e=>{u(""),y()},children:(0,n.jsx)(eQ.Z,{})}),(0,n.jsx)("div",{className:"EvoAnnotator__icon",style:{display:"byClick"===d?"block":"none"},onMouseDown:e=>{e.stopPropagation(),S(),u("")},children:(0,n.jsx)(e$.Z,{})}),(0,n.jsx)("div",{className:"EvoAnnotator__icon",children:(0,n.jsx)(eG.Z,{onMouseDown:e=>{e.stopPropagation(),x&&(navigator.clipboard.writeText(x).then(()=>{e0.ZP.success("复制成功！")}).catch(()=>{e0.ZP.error("复制失败，请重试！")}),u(""))}})})]}),(0,n.jsx)(e4,{epubContentRef:i,viewerRef:t,showAnnotatorByClick:(e,t,i)=>{e.stopPropagation();let n=f(t,e.clientX,e.clientY);v(i.cfi),b(i.text),N(i.id),p(n),u("byClick")}})]})};function e5(){let e=(0,ez._)(["",""]);return e5=function(){return e},e}let e9=eU.ZP.div(e5(),e=>e.$cssText);var e6=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p),{bookProps:i,setBookProps:s,epubRef:a}=(0,r.useContext)(U),o=i.currentSection,l=(0,r.useRef)(null),d=(0,r.useRef)(null),[u,h]=(0,r.useState)(""),[f,g]=(0,r.useState)(""),[m,v]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!a.current)return;s(e=>({...e,currentSectionLoading:!0}));let e=a.current,t=e.getSection(i.currentSectionIndex);t&&e.loadSection(t).then(e=>(h(e.htmlContent),g(e.cssList.join("\n")),s(e=>({...e,currentSection:t,currentSectionLoading:!1})),e)).catch(e=>{})},[e.ebookUrl,i.currentSectionIndex,a.current,s]);let x=(0,r.useCallback)(e=>{var t;let i=null===(t=l.current)||void 0===t?void 0:t.querySelector('[id="'.concat(e.slice(1),'"]'));i&&(i.scrollIntoView({block:"start"}),s(e=>({...e,moveToTarget:""})))},[s]),b=(0,r.useCallback)(e=>{if(!d.current)return;let t=new A(e).toRange(d.current),i=null==t?void 0:t.getBoundingClientRect();if((null==i?void 0:i.height)===0)(null==t?void 0:t.startContainer)instanceof HTMLElement&&(null==t||t.startContainer.scrollIntoView({block:"start"}));else{var n,r;let e=(null===(n=l.current)||void 0===n?void 0:n.scrollTop)||0,t=(null==i?void 0:i.top)||0;null===(r=l.current)||void 0===r||r.scrollTo({top:e+t})}s(e=>({...e,moveToTarget:""}))},[s]);(0,r.useEffect)(()=>{if(i.currentSectionLoading)return;let e=i.moveToTarget;if(""===e){y();return}setTimeout(()=>{var t,n;if(e.startsWith("#"))x(e);else if(A.isCfiString(e)){let n=null===(t=a.current)||void 0===t?void 0:t.getSection(e);if(!n){s(e=>({...e,moveToTarget:""}));return}n.index!==i.currentSectionIndex?s(e=>({...e,currentSectionIndex:n.index})):b(e)}else{let t=null===(n=a.current)||void 0===n?void 0:n.getSection(e);if(!t)return;if(t.index!==i.currentSectionIndex){s(e=>({...e,currentSectionIndex:t.index}));let i=e.indexOf("#");if(i>-1){let t=e.slice(i);s(e=>({...e,moveToTarget:t}))}}}},100)},[i.moveToTarget,i.currentSectionLoading]),(0,r.useEffect)(()=>{if(i.currentSectionLoading||!l.current)return;let e=l.current.querySelectorAll("a");return e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let i=e.getAttribute("href");i&&(i.startsWith("http")?window.open(i):s(e=>({...e,moveToTarget:i})))})}),()=>{e.forEach(e=>{e.removeEventListener("click",()=>{})})}},[i.currentSectionLoading]);let y=(0,r.useCallback)(()=>{if(!d.current||!(null==o?void 0:o.cfiBase))return;let t=new eZ().findStart(d.current,0,window.innerHeight);if(!t)return;let n=new A(t,null==o?void 0:o.cfiBase).toString();s(e=>({...e,currentCfi:n}));let r={bookId:i.id,filePath:e.ebookPath,cfi:n,percent:0,updatedAt:Date.now()};return c.lastReadTable.setLastReadRecord(r,e.ebookPath),n},[null==o?void 0:o.cfiBase]),{run:w}=(0,eV.Z)(e=>{e.target&&d.current&&y()},{wait:200});(0,r.useEffect)(()=>{let e=e=>{var i,n;if("j"===e.key){let e=null===(i=a.current)||void 0===i?void 0:i.getNextSection();e&&t(t=>({...t,currentSectionIndex:e.index}))}if("k"===e.key){let e=null===(n=a.current)||void 0===n?void 0:n.getPrevSection();e&&t(t=>({...t,currentSectionIndex:e.index}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[a,i.currentSectionIndex,t]);let N=(0,r.useMemo)(()=>(0,n.jsx)(e9,{$cssText:f,children:(0,n.jsx)("evo-html",{dangerouslySetInnerHTML:{__html:u},className:eq().content,ref:d})}),[u,f]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eW.Z,{spinning:i.currentSectionLoading,fullscreen:!0,tip:"Loading Section...",size:"large"}),(0,n.jsx)("div",{className:eq().viewer,onScroll:w,id:"evo-viewer",ref:l,children:(0,n.jsx)(e9,{$cssText:e.settings.userContentStyle||"",children:!i.currentSectionLoading&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:eq().contentWrapper,id:"evo-content",children:N}),(0,n.jsx)(e3,{viewerRef:l,epubContentRef:d})]})})})]})},e7=i(6715),e8=i(1773),te=i(9722),tt=i.n(te),ti=i(251),tn=i(6823);let tr=r.forwardRef((e,t)=>{let{className:i,orientation:r="horizontal",decorative:s=!0,...a}=e;return(0,n.jsx)(tn.f,{ref:t,decorative:s,orientation:r,className:en("shrink-0 bg-border","horizontal"===r?"h-[1px] w-full":"h-full w-[1px]",i),...a})});tr.displayName=tn.f.displayName;var ts=()=>{var e,t;let{t:i}=(0,ti.$G)(),{bookProps:s,setBookProps:a}=(0,r.useContext)(U),o=null===(e=s.currentSection)||void 0===e?void 0:e.prevIndex,l=null===(t=s.currentSection)||void 0===t?void 0:t.nextIndex;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(tr,{}),(0,n.jsxs)("div",{className:tt().footer,children:[(0,n.jsxs)("button",{onClick:()=>{void 0!==o&&a(e=>({...e,currentSectionIndex:o}))},disabled:void 0===o||o<0,children:[(0,n.jsx)(e7.Z,{className:"mr-1"}),i("viewer.prev")]}),(0,n.jsx)(tr,{orientation:"vertical"}),(0,n.jsxs)("button",{onClick:()=>{void 0!==l&&a(e=>({...e,currentSectionIndex:l}))},disabled:void 0===l||l<0,children:[i("viewer.next"),(0,n.jsx)(e8.Z,{className:"ml-1"})]})]})]})},ta=i(4324),to=i.n(ta),tl=i(6548),td=i.n(tl),tc=e=>{let{}=e,t=(0,r.useRef)(null);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:td().box,onClick:()=>{var e;return null===(e=t.current)||void 0===e?void 0:e.click()},children:[(0,n.jsx)(W.Z,{style:{fontSize:"40px"}}),(0,n.jsxs)("div",{className:td().label,children:["拖拽文件进窗口 或 ",(0,n.jsx)("span",{style:{color:"#1b88ee"},children:"选择文件"})]}),(0,n.jsx)("div",{children:"支持 epub 格式"})]}),(0,n.jsx)(Q,{mRef:t})]})},tu=()=>{let{readerProps:e,setReaderProps:t}=(0,r.useContext)(p);return(0,r.useEffect)(()=>{let i=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},n=e=>{e.preventDefault(),document.body.classList.add(".is-dragging")},r=e=>{e.preventDefault(),document.body.classList.remove(".is-dragging")},s=i=>{var n;i.preventDefault();let r=null===(n=i.dataTransfer)||void 0===n?void 0:n.files;if(r&&r.length>0){let i=r[0];if(!i)return;if(e.ebookUrl&&URL.revokeObjectURL(e.ebookUrl),"application/epub"!==i.type){alert("Only epub files are supported.");return}let n=URL.createObjectURL(i);t(e=>({...e,ebookUrl:n,ebookPath:i.name,ebookFileName:i.name,ebookSize:i.size}))}};return window.addEventListener("dragenter",n),window.addEventListener("dragleave",r),window.addEventListener("dragover",i),window.addEventListener("drop",s),()=>{window.removeEventListener("dragenter",n),window.removeEventListener("dragleave",r),window.removeEventListener("dragover",i),window.removeEventListener("drop",s)}},[]),(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:to().reader,children:[(0,n.jsx)(ef,{}),""!==e.showSideBar&&(0,n.jsx)(eM,{}),!e.isBookLoading&&""===e.ebookUrl&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:to().main,children:(0,n.jsxs)("div",{className:to().home,children:[(0,n.jsx)("div",{className:to().title,children:"Evo Reader"}),(0,n.jsx)("div",{className:to().box,children:(0,n.jsx)(tc,{})})]})})}),!e.isBookLoading&&""!==e.ebookUrl&&(0,n.jsxs)("div",{className:to().main,children:[(0,n.jsx)(e6,{}),(0,n.jsx)(ts,{})]})]})})},th=i(3968),tp=JSON.parse('{"viewer":{"prev":"Previous","next":"Next"}}'),tf=JSON.parse('{"viewer":{"prev":"上一章","next":"下一章"}}');th.ZP.use(ti.Db).init({lng:"zh_CN",debug:!0,resources:{en:{translation:tp},zh_CN:{translation:tf}}});var tg=i(4033);function tm(){let e=(0,tg.useRouter)();return(0,r.useEffect)(()=>{let t=e.prefetch;return e.prefetch=async()=>{},()=>{e.prefetch=t}},[e]),(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(f,{children:(0,n.jsx)(Z,{children:(0,n.jsx)(q,{children:(0,n.jsx)(tu,{})})})})})}},9046:function(){},6320:function(e){e.exports={ActivityBar:"ActivityBar_ActivityBar__a39dO",icon:"ActivityBar_icon__ThGmC",active:"ActivityBar_active__ahhjF"}},6548:function(e){e.exports={box:"DropFileBox_box__c1WP_",label:"DropFileBox_label___XQ_F"}},4324:function(e){e.exports={reader:"Reader_reader__VQF9J",main:"Reader_main__KheY_",home:"Reader_home__rrgBc",title:"Reader_title__CVEkX",box:"Reader_box__2HFYP"}},7303:function(e){e.exports={sidebar:"SideBar_sidebar__Xzm7R",header:"SideBar_header___y4sB",title:"SideBar_title__aj588",resizer:"SideBar_resizer__OZ5j0"}},4899:function(e){e.exports={container:"Toc_container__onqy6",node:"Toc_node__EAsE6",arrow:"Toc_arrow__Y2H75",label:"Toc_label__YfigH"}},2198:function(e){e.exports={container:"UserStyle_container__DFSW7"}},9722:function(e){e.exports={footer:"ViewerFooter_footer__HYRq4"}},9218:function(e){e.exports={viewer:"EpubViewer_viewer__BSNYB",contentWrapper:"EpubViewer_contentWrapper__QUez8"}}},function(e){e.O(0,[990,537,971,938,744],function(){return e(e.s=2359)}),_N_E=e.O()}]);